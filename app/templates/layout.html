<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>{% block title %}청년 주거 솔루션{% endblock %}</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/layout.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/ai_popup.css') }}">

    {% block page_css %}{% endblock %}
</head>

<body>

<!-- NAVIGATION -->
<nav class="navbar navbar-expand-lg bg-white border-bottom py-2">
    <div class="container-fluid px-4">

        <a class="navbar-brand" href="{{ url_for('index.index') }}">
            <img src="{{ url_for('static', filename='image/logo2.png') }}"
                 alt="청년 주거 솔루션 로고"
                 style="height:40px; width:auto;">
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#topNav">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="topNav">
            <ul class="navbar-nav ms-auto align-items-center">

                <!--  버튼 추가 -->
                <li class="nav-item ms-3">
                    <a id="aiDrawerBtn" class="nav-link" href="javascript:void(0);">생성형 AI</a>
                </li>
                <li class="nav-item ms-3"><a class="nav-link" href="{{ url_for('llama.llama_chat') }}">파인튜닝</a>
                </li>
                <li class="nav-item ms-3"><a class="nav-link" href="{{ url_for('predict.predict_search') }}">전월세 예측</a>
                </li>
                <li class="nav-item ms-3"><a class="nav-link" href="{{ url_for('support.support_search') }}">정부지원 정책</a>
                </li>
                <li class="nav-item ms-3"><a class="nav-link" href="{{ url_for('login.login') }}">로그인</a></li>
                <li class="nav-item ms-3"><a class="nav-link" href="{{ url_for('login.signup') }}">회원가입</a></li>

            </ul>
        </div>

    </div>
</nav>

<!-- CONTENT -->
<main class="{% block main_class %}{% endblock %}">
    {% block content %}{% endblock %}
</main>

<!-- FOOTER -->
<section class="logo-bar">
    <div class="logo-slider">
        <div class="logo-track">

            {% set logos = [
            ('logo_gov24.png','https://www.gov.kr/'),
            ('logo_mailmove.png','https://www.gov.kr/mw/AA020InfoCappView.do?CappBizCD=17210000001'),
            ('logo_movein.png','https://www.gov.kr/mw/AA020InfoCappView.do?CappBizCD=13100000016'),
            ('logo_juso.png','https://www.juso.go.kr/openIndexPage.do'),
            ('logo_iros.png','https://www.iros.go.kr/'),
            ('logo_kepco.png','https://online.kepco.co.kr/'),
            ('logo_seoulgas.png','https://www.seoulgas.co.kr/'),
            ('logo_lh.png','https://www.lh.or.kr/'),
            ('logo_sh.png','https://www.sh.co.kr/'),
            ('logo_reb.png','https://www.reb.or.kr/'),
            ('logo_arisu.png','https://i121.seoul.go.kr/cs/cyber/front/main/NR_index.do'),
            ('logo_molit.png','https://www.molit.go.kr/')
            ] %}

            {% for logo, url in logos %}
            <a href="{{ url }}" target="_blank">
                <img src="{{ url_for('static', filename='image/' ~ logo) }}" class="logo">
            </a>
            {% endfor %}
        </div>
    </div>
</section>

<footer class="footer-section">
    <div class="container px-4">

        <div class="footer-flex">

            <div class="footer-left">
                <img src="{{ url_for('static', filename='image/logo2.png') }}" alt="청년 주거 솔루션 로고" style="height:60px;">
            </div>

            <div class="footer-center">

                <div class="footer-top">
                    청년주거 상담센터 <strong>02-987-6543</strong> │ 데이터·시세 문의 <strong>02-111-2222</strong>
                </div>

                <div class="footer-menu mt-2">
                    <a href="#">회사소개</a>
                    <a href="#">이용안내</a>
                    <a href="#">개인정보처리방침</a>
                </div>

                <div class="footer-bottom mt-2">
                    COPYRIGHT © 2025 YOUTH HOUSING SOLUTION. ALL RIGHTS RESERVED.
                </div>

            </div>

            <div class="footer-right">
                <div class="footer-dropdown">
                    <button class="footer-dropdown-btn" id="dropdownToggle">메뉴 바로가기 ▾</button>

                    <div class="footer-dropdown-list" id="dropdownMenu">
                        <a href="{{ url_for('index.index') }}">메인페이지</a>
                        <a href="{{ url_for('predict.predict_search') }}">전월세 예측</a>
                        <a href="{{ url_for('support.support_search') }}">정부지원 정책</a>
                        <a href="{{ url_for('inquiry.inquiry_list') }}">문의하기</a>
                    </div>
                </div>
            </div>

        </div>

    </div>
</footer>

<script>
    const toggleBtn = document.getElementById("dropdownToggle");
    const menu = document.getElementById("dropdownMenu");

    toggleBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        menu.classList.toggle("show");
    });

    document.addEventListener("click", () => {
        menu.classList.remove("show");
    });
</script>

{% block extra_js %}{% endblock %}

<!-- ============================================================
     AI POPUP (팝업 HTML + JS)
============================================================ -->

<!-- 팝업 배경 -->
<div id="aiModalBg" class="ai-modal-bg"></div>

<!-- 팝업 본체 -->
<div id="aiPopup" class="ai-popup">

    <div class="ai-popup-header" id="aiPopupHeader">
        <span>생성형 AI</span>
        <button id="aiPopupClose" class="ai-close-btn">✕</button>
    </div>

    <!-- 모델 선택 -->
    <div class="ai-model-wrap">
        <div id="aiModelSelected" class="ai-model-pill">
            질의 응답 <span class="arrow">▼</span>
        </div>

        <ul id="aiModelList" class="ai-model-dropdown">
            <li data-value="qa">질의 응답</li>
            <li data-value="textgen">텍스트 생성</li>
            <li data-value="translate">번역</li>
            <li data-value="sentiment">감성 분석</li>
            <li data-value="ner">개체명 인식</li>
        </ul>
    </div>

    <!-- 메시지 영역 -->
    <div class="ai-popup-body" id="aiMessages"></div>

    <!-- 입력창 -->
    <div class="ai-popup-input-wrap">

        <textarea id="aiInput" class="ai-input" placeholder="메시지를 입력하세요"></textarea>

        <div class="ai-btn-row">
            <button id="aiResetBtn" class="ai-reset-btn">대화 지우기</button>
            <button id="aiSendBtn" class="ai-send-btn" disabled>전송</button>
        </div>

    </div>

</div>


<!-- AI POPUP SCRIPT -->
<script>

    /* 1) 대화 전체를 context로 만드는 함수 */
    function buildConversationContext() {
        const messageEls = document.querySelectorAll(".message");
        let contextText = "";

        messageEls.forEach(msg => {
            const text = msg.innerText.trim();
            if (!text) return;

            // 사용자, AI 구분 없이 그냥 문장만 context로 축적
            contextText += text + "\n";
        });

        return contextText.trim();
    }

    /* 2) 팝업 기능 스크립트 */
    document.addEventListener("DOMContentLoaded", () => {

        const modalBg = document.getElementById("aiModalBg");
        const popup = document.getElementById("aiPopup");
        const openBtn = document.getElementById("aiDrawerBtn");
        const closeBtn = document.getElementById("aiPopupClose");

        const messages = document.getElementById("aiMessages");
        const input = document.getElementById("aiInput");
        const sendBtn = document.getElementById("aiSendBtn");
        const resetBtn = document.getElementById("aiResetBtn");

        const modelBox = document.getElementById("aiModelSelected");
        const modelList = document.getElementById("aiModelList");

        let currentModel = "qa";

        /* 팝업 열기 */
        openBtn.addEventListener("click", () => {
            modalBg.style.display = "block";
            popup.style.display = "block";
            input.focus();
        });

        /* 팝업 닫기 */
        closeBtn.addEventListener("click", () => {
            modalBg.style.display = "none";
            popup.style.display = "none";
        });

        /* 드래그 이동 */
        const header = document.getElementById("aiPopupHeader");
        let isDown = false, offsetX = 0, offsetY = 0;

        header.addEventListener("mousedown", (e) => {
            isDown = true;

            const rect = popup.getBoundingClientRect();

            // transform 제거 전, 현재 화면상의 절대 위치를 저장
            const currentLeft = rect.left;
            const currentTop = rect.top;

            // transform 제거 + 실제 위치 적용
            popup.style.transform = "none";
            popup.style.left = currentLeft + "px";
            popup.style.top = currentTop + "px";

            // 드래그를 위한 offset 계산
            offsetX = e.clientX - currentLeft;
            offsetY = e.clientY - currentTop;
        });


        document.addEventListener("mouseup", () => (isDown = false));

        document.addEventListener("mousemove", (e) => {
            if (!isDown) return;
            popup.style.left = `${e.clientX - offsetX}px`;
            popup.style.top = `${e.clientY - offsetY}px`;
        });

        /* 모델 선택 */
        modelBox.addEventListener("click", (e) => {
            e.stopPropagation();
            modelList.style.display =
                modelList.style.display === "block" ? "none" : "block";
        });

        modelList.querySelectorAll("li").forEach(item => {
            item.addEventListener("click", () => {
                currentModel = item.getAttribute("data-value");
                modelBox.innerHTML = `${item.textContent} <span class="arrow">▼</span>`;
                modelList.style.display = "none";
            });
        });

        document.addEventListener("click", () => modelList.style.display = "none");

        /* 입력 감지 */
        input.addEventListener("input", () => {
            sendBtn.disabled = input.value.trim().length === 0;
        });

        /* 메시지 전송 */
        async function sendMessage() {

            const text = input.value.trim();
            if (!text) return;

            messages.innerHTML += `<div class="message user">${text}</div>`;
            messages.scrollTop = messages.scrollHeight;

            input.value = "";
            sendBtn.disabled = true;

            // 로딩 메시지
            const loadingId = "load-" + Date.now();
            messages.innerHTML += `<div id="${loadingId}" class="message bot"><span class="loading-dots"></span></div>`;
            messages.scrollTop = messages.scrollHeight;

            /* QA 모델일 경우 대화내역을 context 로 전송 */
            const conversationContext =
                currentModel === "qa"
                    ? buildConversationContext()
                    : "";

            const response = await fetch("/ai-chat", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    question: text,
                    model: currentModel,
                    conversation: conversationContext  // ★ 중요! context 포함
                })
            });

            const data = await response.json();

            document.getElementById(loadingId)?.remove();

            messages.innerHTML += `<div class="message bot">${data.answer}</div>`;
            messages.scrollTop = messages.scrollHeight;
        }

        sendBtn.addEventListener("click", sendMessage);

        input.addEventListener("keydown", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                if (!sendBtn.disabled) sendMessage();
            }
        });

        /* 대화 지우기 */
        resetBtn.addEventListener("click", () => {
            messages.innerHTML = `<div class="message bot">대화가 초기화되었습니다.</div>`;
            input.value = "";
            sendBtn.disabled = true;
        });

    });
</script>

</body>
</html>
