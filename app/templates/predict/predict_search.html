<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì „Â·ì›”ì„¸ ë§¤ë¬¼ ì§€ë„</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- ì˜ˆì¸¡ ì „ìš© CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/predict.css') }}">

    <!-- Kakao Maps API -->
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=c5088b72ab06ffaf3fd6a9a1f513bc01&autoload=false"></script>

    <!-- Chart.js (ì˜ˆì¸¡ ì°¨íŠ¸ìš©) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<nav class="navbar navbar-expand-lg predict-navbar">
    <div class="container-fluid px-4">

        <a class="navbar-brand" href="{{ url_for('index.index') }}">
            <img src="{{ url_for('static', filename='image/logo2.png') }}"
                 alt="ì²­ë…„ ì£¼ê±° ì†”ë£¨ì…˜ ë¡œê³ "
                 style="height:40px; width:auto;">
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#topNav">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="topNav">
            <ul class="navbar-nav ms-auto align-items-center">
                <li class="nav-item ms-3"><a class="nav-link" href="{{ url_for('predict.predict_search') }}">ì „ì›”ì„¸ ì˜ˆì¸¡</a>
                </li>
                <li class="nav-item ms-3"><a class="nav-link" href="{{ url_for('support.support_search') }}">ì •ë¶€ì§€ì›</a>
                </li>
                <li class="nav-item ms-3"><a class="nav-link" href="{{ url_for('login.login') }}">ë¡œê·¸ì¸</a></li>
                <li class="nav-item ms-3"><a class="nav-link" href="{{ url_for('login.signup') }}">íšŒì›ê°€ì…</a></li>
            </ul>
        </div>

    </div>
</nav>

<div id="header-placeholder"></div>

<div class="page-wrapper">

    <!-- ì§€ë„ -->
    <div class="map-panel">

        <!-- ğŸ”µ í•„í„° í† ê¸€ ë²„íŠ¼ (ìŠ¬ë¼ì´ë“œ ë²„íŠ¼) -->
        <button id="filterToggleBtn" class="filter-toggle-btn">
            <svg width="26" height="26" viewBox="0 0 24 24">
                <path d="M3 6h18M3 12h18M3 18h18"
                      stroke="#000"
                      stroke-width="2"
                      stroke-linecap="round"/>
            </svg>
        </button>

        <!-- ğŸ”µ ìŠ¬ë¼ì´ë“œ ì»¨í…Œì´ë„ˆ (í•„í„°Panelì„ ê°ì‹¸ëŠ” ì™¸ê³½) -->
        <div id="filterContainer" class="filter-container">

            <!-- ê¸°ì¡´ ê²€ìƒ‰ í•„í„° -->
            <div id="filterPanel" class="filter-panel">
                <div class="filter-grid">

                    <!-- ì§€ì—­ -->
                    <div class="filter-item">
                        <label>ì§€ì—­</label>
                        <select id="filterGu" class="form-select form-select-sm">
                            <option value="eunpyeong" {% if init_filter.gu=="eunpyeong" %}selected{% endif %}>ì€í‰êµ¬
                            </option>
                            <option value="guro" {% if init_filter.gu=="guro" %}selected{% endif %}>êµ¬ë¡œêµ¬</option>
                        </select>
                    </div>

                    <!-- ì£¼íƒìœ í˜• -->
                    <div class="filter-item">
                        <label>ì£¼íƒìœ í˜•</label>
                        <select id="filterHouseType" class="form-select form-select-sm">
                            <option value="ì˜¤í”¼ìŠ¤í…”" {% if init_filter.house_type=="ì˜¤í”¼ìŠ¤í…”" %}selected{% endif %}>ì˜¤í”¼ìŠ¤í…”
                            </option>
                            <option value="ë¹Œë¼" {% if init_filter.house_type=="ë¹Œë¼" %}selected{% endif %}>ë¹Œë¼</option>
                        </select>
                    </div>

                    <!-- ê±°ë˜ìœ í˜• -->
                    <div class="filter-item">
                        <label>ê±°ë˜ìœ í˜•</label>
                        <select id="filterTradeType" class="form-select form-select-sm">
                            <option value="ì „ì„¸" {% if init_filter.lease_type=="ì „ì„¸" %}selected{% endif %}>ì „ì„¸</option>
                            <option value="ì›”ì„¸" {% if init_filter.lease_type=="ì›”ì„¸" %}selected{% endif %}>ì›”ì„¸</option>
                        </select>
                    </div>

                    <!-- ë©´ì  -->
                    <div class="filter-item">
                        <label>ë©´ì </label>
                        <select id="filterArea" class="form-select form-select-sm">
                            <option value="0-9" {% if init_filter.area=="0-9" %}selected{% endif %}>10í‰ ë¯¸ë§Œ</option>
                            <option value="10-19" {% if init_filter.area=="10-19" %}selected{% endif %}>10í‰ëŒ€</option>
                            <option value="20-29" {% if init_filter.area=="20-29" %}selected{% endif %}>20í‰ëŒ€</option>
                            <option value="30-999" {% if init_filter.area=="30-999" %}selected{% endif %}>ê¸°íƒ€</option>
                        </select>
                    </div>

                    <!-- ì¸µìˆ˜ -->
                    <div class="filter-item">
                        <label>ì¸µìˆ˜</label>
                        <select id="filterFloor" class="form-select form-select-sm">
                            <option value="all" {% if init_filter.floor=="all" %}selected{% endif %}>ì „ì²´</option>
                            <option value="basement" {% if init_filter.floor=="basement" %}selected{% endif %}>ì§€í•˜
                            </option>
                            <option value="low" {% if init_filter.floor=="low" %}selected{% endif %}>ì €ì¸µ</option>
                            <option value="mid" {% if init_filter.floor=="mid" %}selected{% endif %}>ì¤‘ì¸µ</option>
                            <option value="high" {% if init_filter.floor=="high" %}selected{% endif %}>ê³ ì¸µ</option>
                        </select>
                    </div>

                </div>

                <button class="btn btn-primary w-100 btn-sm mt-2" id="applyFilter">ê²€ìƒ‰í•˜ê¸°</button>
            </div>

        </div>

        <!-- ì¹´ì¹´ì˜¤ ì§€ë„ -->
        <div id="map"></div>

        <!-- ğŸŸ¦ ì˜ˆì¸¡ íŒì—… íŒ¨ë„ (ì§€ë„ ìœ„ì— ëœ¨ëŠ” ì°½) -->
        <div id="detailPanel" class="property-detail-panel" style="display:none;">
            <div class="detail-header">
                <div class="detail-title-row">
                    <div id="detailTitle" class="detail-title"></div>
                    <button type="button" id="detailCloseBtn" class="detail-close-btn">&times;</button>
                </div>
                <div class="detail-summary">
                    <div id="detailRecentInfo" class="detail-recent-info"></div>
                    <div id="detailRecentPrice" class="detail-recent-price"></div>
                </div>
            </div>

            <div class="detail-body">
                <div class="detail-year-row">
                    <label for="detailYearSelect" class="detail-year-label">ì˜ˆìƒ ì—°ë„</label>
                    <select id="detailYearSelect" class="form-select form-select-sm detail-year-select">
                        <option value="2025">2025ë…„</option>
                        <option value="2026" selected>2026ë…„</option>
                        <option value="2027">2027ë…„</option>
                        <option value="2028">2028ë…„</option>
                        <option value="2029">2029ë…„</option>
                        <option value="2030">2030ë…„</option>
                    </select>
                </div>

                <div class="detail-charts">
                    <div class="chart-block">
                        <h6 class="chart-title">ë³´ì¦ê¸ˆ ì˜ˆì¸¡</h6>
                        <div class="chart-wrapper">
                            <canvas id="depositChart"></canvas>
                        </div>
                        <div id="depositScore" class="chart-score"></div>
                    </div>

                    <div class="chart-block" id="monthlyChartBlock">
                        <h6 class="chart-title">ì›”ì„¸ ì˜ˆì¸¡</h6>
                        <div class="chart-wrapper">
                            <canvas id="monthlyChart"></canvas>
                        </div>
                        <div id="monthlyScore" class="chart-score"></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- ğŸŸ¦ ì˜ˆì¸¡ íŒì—… ë -->

    </div>

    <!-- ë¦¬ìŠ¤íŠ¸ -->
    <aside class="list-panel">

        <div class="list-header">
            <div class="list-header-title">
                {{ "ì€í‰êµ¬" if init_filter.gu == "eunpyeong" else "êµ¬ë¡œêµ¬" }}
                {{ init_filter.lease_type }} {{ init_filter.house_type }} ë§¤ë¬¼
            </div>
            <div class="list-header-sub">
                ì´ <strong id="listCount">{{ items|length }}</strong>ê°œ ë§¤ë¬¼
            </div>
        </div>

        <!-- ì •ë ¬ì„ íƒ (ì¶”ì²œìˆœ ì œê±°) -->
        <div class="list-toolbar">
            <div class="toolbar-filters">

                <span class="filter-chip active">
                    {% if init_filter.area == "10-19" %}
                        10í‰ëŒ€
                    {% elif init_filter.area == "20-29" %}
                        20í‰ëŒ€
                    {% elif init_filter.area == "0-9" %}
                        10í‰ ë¯¸ë§Œ
                    {% else %}
                        ê¸°íƒ€
                    {% endif %}
                </span>

                {% if init_filter.floor == "low" %}
                <span class="filter-chip active">1~4ì¸µ</span>
                {% elif init_filter.floor == "mid" %}
                <span class="filter-chip active">5~10ì¸µ</span>
                {% elif init_filter.floor == "high" %}
                <span class="filter-chip active">11ì¸µ ì´ìƒ</span>
                {% elif init_filter.floor == "basement" %}
                <span class="filter-chip active">ì§€í•˜ì¸µ</span>
                {% else %}
                <span class="filter-chip active">ì „ì²´ì¸µ</span>
                {% endif %}

                <span class="filter-chip">{{ init_filter.house_type }}</span>
                <span class="filter-chip">{{ init_filter.lease_type }}</span>
            </div>

            <div class="toolbar-sort">
                <select id="sortSelect" class="form-select form-select-sm">
                    <option value="deposit_desc">ë³´ì¦ê¸ˆ ë†’ì€ìˆœ</option>
                    <option value="deposit_asc">ë³´ì¦ê¸ˆ ë‚®ì€ìˆœ</option>
                    <option value="monthly_desc">ì›”ì„¸ ë†’ì€ìˆœ</option>
                    <option value="monthly_asc">ì›”ì„¸ ë‚®ì€ìˆœ</option>
                </select>
            </div>
        </div>

        <div class="list-body" id="listBody"></div>
    </aside>

</div>

<div id="footer-placeholder"></div>

<!-- í•„í„° ì ìš© -->
<script>
    document.getElementById("applyFilter").addEventListener("click", () => {
        // ğŸ”µ ë¡œë”© ì˜¤ë²„ë ˆì´ í‘œì‹œ
        const overlay = document.getElementById("loadingOverlay");
        if (overlay) {
            overlay.style.display = "flex";
        }

        // ğŸ”µ í•„í„° ê°’ ì½ê¸°
        const gu = document.getElementById("filterGu").value;
        const houseType = document.getElementById("filterHouseType").value;
        const leaseType = document.getElementById("filterTradeType").value;
        const area = document.getElementById("filterArea").value;
        const floor = document.getElementById("filterFloor").value;

        // ğŸ”µ í˜ì´ì§€ ì´ë™ (ì„œë²„ ê²€ìƒ‰ ìš”ì²­)
        location.href =
            `/predict/search?gu=${gu}&house_type=${houseType}&lease_type=${leaseType}&area=${area}&floor=${floor}`;
    });

</script>

<!-- ì„œë²„ ë°ì´í„° -->
<script>
    const ALL_PROPERTIES = [
        {% for item in items %}
        {
            idx: {{ loop.index0 }},  // ğŸ”‘ ê³ ìœ  ì¸ë±ìŠ¤ (ë§ˆì»¤/ë¦¬ìŠ¤íŠ¸ ì—°ë™ìš©)
            lat: {{ item.latitude or 'null' }},
            lng: {{ item.longitude or 'null' }},
            building_name: {{ item.building_name|tojson }},
            dong_name: {{ item.dong_name|tojson }},
            district: {{ item.district|tojson }},
            floor: {{ item.floor|tojson }},
            area_p: {{ item.area_p|tojson }},
            house_type: {{ item.house_type|tojson }},
            lease_type: {{ item.lease_type|tojson }},
            recent_yq: {{ item.recent_yq|tojson }},
            jibun_address: {{ item.jibun_address|tojson }},
            recent_deposit: {{ item.recent_deposit or 'null' }},
            recent_monthly: {{ item.recent_monthly or 'null' }},

            deposit_25q1: {{ item.deposit_25q1 or 'null' }},
            deposit_25q2: {{ item.deposit_25q2 or 'null' }},
            deposit_25q3: {{ item.deposit_25q3 or 'null' }},
            deposit_25q4: {{ item.deposit_25q4 or 'null' }},
            deposit_26q1: {{ item.deposit_26q1 or 'null' }},
            deposit_26q2: {{ item.deposit_26q2 or 'null' }},
            deposit_26q3: {{ item.deposit_26q3 or 'null' }},
            deposit_26q4: {{ item.deposit_26q4 or 'null' }},
            deposit_27q1: {{ item.deposit_27q1 or 'null' }},
            deposit_27q2: {{ item.deposit_27q2 or 'null' }},
            deposit_27q3: {{ item.deposit_27q3 or 'null' }},
            deposit_27q4: {{ item.deposit_27q4 or 'null' }},
            deposit_28q1: {{ item.deposit_28q1 or 'null' }},
            deposit_28q2: {{ item.deposit_28q2 or 'null' }},
            deposit_28q3: {{ item.deposit_28q3 or 'null' }},
            deposit_28q4: {{ item.deposit_28q4 or 'null' }},
            deposit_29q1: {{ item.deposit_29q1 or 'null' }},
            deposit_29q2: {{ item.deposit_29q2 or 'null' }},
            deposit_29q3: {{ item.deposit_29q3 or 'null' }},
            deposit_29q4: {{ item.deposit_29q4 or 'null' }},
            deposit_30q1: {{ item.deposit_30q1 or 'null' }},
            deposit_30q2: {{ item.deposit_30q2 or 'null' }},
            deposit_30q3: {{ item.deposit_30q3 or 'null' }},
            deposit_30q4: {{ item.deposit_30q4 or 'null' }},

            monthly_rent_25q1: {{ item.monthly_rent_25q1 or 'null' }},
            monthly_rent_25q2: {{ item.monthly_rent_25q2 or 'null' }},
            monthly_rent_25q3: {{ item.monthly_rent_25q3 or 'null' }},
            monthly_rent_25q4: {{ item.monthly_rent_25q4 or 'null' }},
            monthly_rent_26q1: {{ item.monthly_rent_26q1 or 'null' }},
            monthly_rent_26q2: {{ item.monthly_rent_26q2 or 'null' }},
            monthly_rent_26q3: {{ item.monthly_rent_26q3 or 'null' }},
            monthly_rent_26q4: {{ item.monthly_rent_26q4 or 'null' }},
            monthly_rent_27q1: {{ item.monthly_rent_27q1 or 'null' }},
            monthly_rent_27q2: {{ item.monthly_rent_27q2 or 'null' }},
            monthly_rent_27q3: {{ item.monthly_rent_27q3 or 'null' }},
            monthly_rent_27q4: {{ item.monthly_rent_27q4 or 'null' }},
            monthly_rent_28q1: {{ item.monthly_rent_28q1 or 'null' }},
            monthly_rent_28q2: {{ item.monthly_rent_28q2 or 'null' }},
            monthly_rent_28q3: {{ item.monthly_rent_28q3 or 'null' }},
            monthly_rent_28q4: {{ item.monthly_rent_28q4 or 'null' }},
            monthly_rent_29q1: {{ item.monthly_rent_29q1 or 'null' }},
            monthly_rent_29q2: {{ item.monthly_rent_29q2 or 'null' }},
            monthly_rent_29q3: {{ item.monthly_rent_29q3 or 'null' }},
            monthly_rent_29q4: {{ item.monthly_rent_29q4 or 'null' }},
            monthly_rent_30q1: {{ item.monthly_rent_30q1 or 'null' }},
            monthly_rent_30q2: {{ item.monthly_rent_30q2 or 'null' }},
            monthly_rent_30q3: {{ item.monthly_rent_30q3 or 'null' }},
            monthly_rent_30q4: {{ item.monthly_rent_30q4 or 'null' }}

        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
</script>

<!-- ì§€ë„ ì „ì²´ë¡œì§ -->
<script>
    kakao.maps.load(function () {

        /*************************************************
         * ê³µìš© ìƒíƒœ ë³€ìˆ˜
         *************************************************/
        const valid = ALL_PROPERTIES.filter(p => p.lat && p.lng);

        // ì„ íƒ ìƒíƒœ
        let selectedIdx = null;
        let selectedMarker = null;

        // ì¸ë±ìŠ¤ë¡œ ë§ˆì»¤/ì¹´ë“œ ì°¾ê¸°
        const markerByIdx = {};
        const cardByIdx = {};

        // ì¤Œ ì´ë²¤íŠ¸ì—ì„œ í•œ ë²ˆì€ ì„ íƒ ìœ ì§€í•˜ë„ë¡ í•˜ëŠ” í”Œë˜ê·¸
        let suppressClearOnNextZoom = false;

        /*************************************************
         * ì§€ë„ ì´ˆê¸°í™”
         *************************************************/
        const avgLat = valid.reduce((s, p) => s + p.lat, 0) / valid.length;
        const avgLng = valid.reduce((s, p) => s + p.lng, 0) / valid.length;

        const map = new kakao.maps.Map(document.getElementById("map"), {
            center: new kakao.maps.LatLng(avgLat, avgLng),
            level: 6
        });

        /*************************************************
         * íŒì—…/ì°¨íŠ¸ ê´€ë ¨ DOM & ìƒíƒœ
         *************************************************/
        const detailPanel = document.getElementById("detailPanel");
        const detailTitle = document.getElementById("detailTitle");
        const detailRecentInfo = document.getElementById("detailRecentInfo");
        const detailRecentPrice = document.getElementById("detailRecentPrice");
        const detailYearSelect = document.getElementById("detailYearSelect");
        const depositChartCanvas = document.getElementById("depositChart");
        const monthlyChartCanvas = document.getElementById("monthlyChart");
        const monthlyChartBlock = document.getElementById("monthlyChartBlock");

        let depositChartInstance = null;
        let monthlyChartInstance = null;

        function formatNumber(n) {
            if (n === null || n === undefined || n === "" || isNaN(Number(n))) return "-";
            return Number(n).toLocaleString("ko-KR");
        }

        /*************************************************
         * íŒì—… ë‹«ê¸°
         *************************************************/
        function closeDetailPanel() {
            if (!detailPanel) return;
            detailPanel.style.display = "none";

            if (depositChartInstance) {
                depositChartInstance.destroy();
                depositChartInstance = null;
            }
            if (monthlyChartInstance) {
                monthlyChartInstance.destroy();
                monthlyChartInstance = null;
            }
        }

        // X ë²„íŠ¼
        const detailCloseBtn = document.getElementById("detailCloseBtn");
        if (detailCloseBtn) {
            detailCloseBtn.addEventListener("click", () => {
                closeDetailPanel();
                // ì„ íƒë„ ê°™ì´ í•´ì œ
                clearSelection();
            });
        }

        /*************************************************
         * ì—°ë„ë³„ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
         *************************************************/
        function updateCharts(p) {
            if (!depositChartCanvas || !detailYearSelect) return;

            const yearStr = detailYearSelect.value || "2026";
            const yearSuffix = yearStr.slice(2); // "26" í˜•íƒœ

            const labels = ["1ë¶„ê¸°", "2ë¶„ê¸°", "3ë¶„ê¸°", "4ë¶„ê¸°"];
            const depositValues = [];
            const monthlyValues = [];

            for (let q = 1; q <= 4; q++) {
                const dqKey = `deposit_${yearSuffix}q${q}`;
                const mqKey = `monthly_rent_${yearSuffix}q${q}`;

                let dv = Number(p[dqKey]);
                if (!isFinite(dv)) dv = null;
                depositValues.push(dv);

                let mv = Number(p[mqKey]);
                if (!isFinite(mv)) mv = null;
                monthlyValues.push(mv);
            }

            // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
            if (depositChartInstance) {
                depositChartInstance.destroy();
            }

            /**********************************************
             * ë³´ì¦ê¸ˆ ì°¨íŠ¸ (ì „ì„¸ / ì›”ì„¸ ëª¨ë‘ ê³µí†µ)
             **********************************************/
            depositChartInstance = new Chart(depositChartCanvas.getContext("2d"), {
                type: "line",
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${yearStr}ë…„ ë¶„ê¸°ë³„ ë³´ì¦ê¸ˆ`,
                        data: depositValues,
                        borderColor: "#1b64da",
                        pointBackgroundColor: "#1b64da",
                        tension: 0.2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: Math.min(...depositValues) * 0.97,
                            max: Math.max(...depositValues) * 1.03,
                            ticks: {
                                callback: value => value.toLocaleString("ko-KR")
                            }
                        }
                    }
                }
            });


            /**********************************************
             * ì›”ì„¸ ì°¨íŠ¸ (ì›”ì„¸ì¼ ë•Œë§Œ í‘œì‹œ)
             **********************************************/
            if (p.lease_type === "ì›”ì„¸") {
                if (monthlyChartCanvas) {
                    if (monthlyChartInstance) monthlyChartInstance.destroy();
                }

                monthlyChartInstance = new Chart(monthlyChartCanvas.getContext("2d"), {
                    type: "line",
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `${yearStr}ë…„ ë¶„ê¸°ë³„ ì›”ì„¸`,
                            data: monthlyValues,
                            borderColor: "#ff6b00",
                            pointBackgroundColor: "#ff6b00",
                            tension: 0.2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                beginAtZero: false,
                                min: Math.min(...monthlyValues) * 0.95,
                                max: Math.max(...monthlyValues) * 1.05,
                                ticks: {
                                    callback: value => value.toLocaleString("ko-KR")
                                }
                            }
                        }
                    }
                });

                if (monthlyChartBlock) monthlyChartBlock.style.display = "block";
            } else {
                // ì „ì„¸: ì›”ì„¸ ì°¨íŠ¸ ìˆ¨ê¹€
                if (monthlyChartBlock) monthlyChartBlock.style.display = "none";
                if (monthlyChartInstance) {
                    monthlyChartInstance.destroy();
                    monthlyChartInstance = null;
                }
            }


            /**********************************************
             * ğŸ”¥ ì—¬ê¸°ì„œ ëª¨ë¸ ì •í™•ë„ í‘œì‹œ
             **********************************************/
            const depositScoreDiv = document.getElementById("depositScore");
            const monthlyScoreDiv = document.getElementById("monthlyScore");

            if (p.lease_type === "ì „ì„¸") {
                // ì „ì„¸ ë³´ì¦ê¸ˆ ëª¨ë¸ ì •í™•ë„
                if (depositScoreDiv) depositScoreDiv.textContent = "ì˜ˆì¸¡ ì •í™•ë„: 88%";
                if (monthlyScoreDiv) monthlyScoreDiv.textContent = "";
            }

            else if (p.lease_type === "ì›”ì„¸") {
                // ì›”ì„¸ ëª¨ë¸ì˜ ë³´ì¦ê¸ˆ & ì›”ì„¸ ëª¨ë‘ 29%
                if (depositScoreDiv) depositScoreDiv.textContent = "ì˜ˆì¸¡ ì •í™•ë„: 29%";
                if (monthlyScoreDiv) monthlyScoreDiv.textContent = "ì˜ˆì¸¡ ì •í™•ë„: 29%";
            }
        }


        // ì—°ë„ ì„ íƒ ë³€ê²½ ì‹œ ì°¨íŠ¸ ê°±ì‹ 
        if (detailYearSelect) {
            detailYearSelect.addEventListener("change", () => {
                if (selectedIdx !== null) {
                    const p = valid.find(x => x.idx === selectedIdx);
                    if (p) updateCharts(p);
                }
            });
        }

        /*************************************************
         * íŒì—… ì—´ê¸°
         *************************************************/
        function openDetailPanel(p) {
            if (!detailPanel) return;

            detailTitle.textContent = p.building_name || "";
            detailRecentInfo.textContent = p.recent_yq || "ìµœê·¼ ê³„ì•½ ì •ë³´ ì—†ìŒ";

            let priceText = "";
            if (p.lease_type === "ì „ì„¸") {
                if (p.recent_deposit) {
                    priceText = `ì „ì„¸ ${formatNumber(p.recent_deposit)}ë§Œì›`;
                } else {
                    priceText = "ì „ì„¸ ì˜ˆì¸¡ ê¸ˆì•¡";
                }
            } else if (p.lease_type === "ì›”ì„¸") {
                if (p.recent_deposit || p.recent_monthly) {
                    priceText = `ë³´ì¦ê¸ˆ ${formatNumber(p.recent_deposit)} / ì›”ì„¸ ${formatNumber(p.recent_monthly)}ë§Œì›`;
                } else {
                    priceText = "ì›”ì„¸ ì˜ˆì¸¡ ê¸ˆì•¡";
                }
            }
            detailRecentPrice.textContent = priceText;

            // ê¸°ë³¸ ì—°ë„ 2026
            if (detailYearSelect && !detailYearSelect.value) {
                detailYearSelect.value = "2026";
            }

            updateCharts(p);
            detailPanel.style.display = "block";
        }

        /*************************************************
         * ë§ˆì»¤ ì´ë¯¸ì§€ (ê¸°ë³¸ / ì„ íƒ)
         *************************************************/
        const markerDefaultImage = null;

        const markerSelectedImage = new kakao.maps.MarkerImage(
            "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png",
            new kakao.maps.Size(24, 35),
            {offset: new kakao.maps.Point(12, 35)}
        );

        /*************************************************
         * ë™ ë‹¨ìœ„ í´ëŸ¬ìŠ¤í„° ìƒì„±
         *************************************************/
        const dongGroups = {};

        valid.forEach(p => {
            const d = p.dong_name || "ê¸°íƒ€";
            if (!dongGroups[d]) {
                dongGroups[d] = { items: [], sumLat: 0, sumLng: 0 };
            }
            dongGroups[d].items.push(p);
            dongGroups[d].sumLat += p.lat;
            dongGroups[d].sumLng += p.lng;
        });

        const dongOverlays = [];

        function createDongClusters() {
            for (let d in dongGroups) {
                const g = dongGroups[d];
                const lat = g.sumLat / g.items.length;
                const lng = g.sumLng / g.items.length;

                const overlay = new kakao.maps.CustomOverlay({
                    position: new kakao.maps.LatLng(lat, lng),
                    yAnchor: 1,
                    map: map,
                    content: `
                        <div class="dong-cluster" onclick="zoomToDong('${d}')">
                            <div class="dong-name">${d}</div>
                            <div class="dong-count">${g.items.length}ê°€êµ¬</div>
                        </div>
                    `
                });
                dongOverlays.push(overlay);
            }
        }

        window.zoomToDong = (dong) => {
            const g = dongGroups[dong];
            const lat = g.sumLat / g.items.length;
            const lng = g.sumLng / g.items.length;

            suppressClearOnNextZoom = true;  // ì´ ì¤Œì—ì„œëŠ” ì„ íƒ ìœ ì§€
            map.setLevel(4);
            map.panTo(new kakao.maps.LatLng(lat, lng));
        };

        /*************************************************
         * ê°œë³„ ë§ˆì»¤ ìƒì„± + í´ë¦­ ì´ë²¤íŠ¸ (ë¦¬ìŠ¤íŠ¸ ì—°ë™)
         *************************************************/
        const markers = [];

        valid.forEach(p => {
            const marker = new kakao.maps.Marker({
                position: new kakao.maps.LatLng(p.lat, p.lng),
                map: null,
                image: markerDefaultImage
            });
            marker.data = p;
            markerByIdx[p.idx] = marker;
            markers.push(marker);

            kakao.maps.event.addListener(marker, "click", function () {

                const pos = marker.getPosition();

                // ì§€ë„ ì´ë™
                map.panTo(pos);
                setTimeout(() => map.setLevel(2), 200);

                // ì´ë™ í›„ ì¤Œì¸
                setTimeout(() => {
                    map.setLevel(2);   // ìˆ«ì ì‘ì„ìˆ˜ë¡ í™•ëŒ€
                }, 200);

                selectByIdx(p.idx, false);
            });
        });

        /*************************************************
         * ì„ íƒ ìƒíƒœ ì´ˆê¸°í™”
         *************************************************/
        function clearSelection() {
            // ë§ˆì»¤ ê°•ì¡° í•´ì œ
            if (selectedMarker) {
                selectedMarker.setImage(markerDefaultImage);
                selectedMarker = null;
            }
            selectedIdx = null;

            // ì¹´ë“œ ê°•ì¡° í•´ì œ
            Object.values(cardByIdx).forEach(card => {
                card.classList.remove("active");
            });

            // íŒì—…ë„ ê°™ì´ ë‹«ê¸°
            closeDetailPanel();
        }

        /*************************************************
         * ì¸ë±ìŠ¤ë¡œ ì„ íƒ ì²˜ë¦¬ (ë§ˆì»¤/ë¦¬ìŠ¤íŠ¸ ì—°ë™)
         * fromList=true ì´ë©´ ë¦¬ìŠ¤íŠ¸ì—ì„œ ì„ íƒí•œ ê²ƒ
         *************************************************/
        function selectByIdx(idx, fromList) {
            const p = valid.find(x => x.idx === idx);
            if (!p) return;

            // ì´ì „ ì„ íƒ í•´ì œ
            clearSelection();

            // ë§ˆì»¤ ê°•ì¡°
            const marker = markerByIdx[idx];
            if (marker) {
                marker.setImage(markerSelectedImage);
                selectedMarker = marker;
                selectedIdx = idx;
            }

            // ë¦¬ìŠ¤íŠ¸ ì¹´ë“œ ê°•ì¡° + ìŠ¤í¬ë¡¤
            const card = cardByIdx[idx];
            if (card) {
                card.classList.add("active");
                card.scrollIntoView({ behavior: "smooth", block: "center" });
            }

            // ë¦¬ìŠ¤íŠ¸ì—ì„œ ì„ íƒí–ˆì„ ë•Œ ì§€ë„ ì´ë™/ì¤Œ ì²˜ë¦¬
            if (fromList && marker) {
                suppressClearOnNextZoom = true;   // ğŸš€ ë¦¬ìŠ¤íŠ¸ í´ë¦­ìœ¼ë¡œ ì¸í•œ ì¤Œ â†’ ì„ íƒ í•´ì œ ê¸ˆì§€

                const pos = marker.getPosition();
                map.panTo(pos);

                setTimeout(() => {
                    suppressClearOnNextZoom = true; // ğŸš€ setLevel ë°œìƒ ì „ ì•ˆì „í•˜ê²Œ í•œ ë²ˆ ë”
                    map.setLevel(2);
                }, 200);

                setTimeout(() => {
                    suppressClearOnNextZoom = true; // ğŸš€ í˜¹ì‹œ ëª°ë¼ í•œ ë²ˆ ë” ë³´ê°•
                    map.setLevel(2);
                }, 200);
            }

            // ğŸ”¹ ì„ íƒëœ ë§¤ë¬¼ì˜ íŒì—… ì˜¤í”ˆ
            openDetailPanel(p);
        }

        /*************************************************
         * í˜„ì¬ ì§€ë„ ë²”ìœ„ ë‚´ ë§¤ë¬¼ë§Œ ë°˜í™˜
         *************************************************/
        function getVisibleItems() {
            const bounds = map.getBounds();
            const sw = bounds.getSouthWest();
            const ne = bounds.getNorthEast();

            return valid.filter(p =>
                p.lat >= sw.getLat() &&
                p.lat <= ne.getLat() &&
                p.lng >= sw.getLng() &&
                p.lng <= ne.getLng()
            );
        }

        /*************************************************
         * ì •ë ¬ ê¸°ëŠ¥
         *************************************************/
        function sortItems(items) {
            const sortType = document.getElementById("sortSelect").value;

            if (sortType === "deposit_desc")
                return items.sort((a,b)=> (b.recent_deposit||0)-(a.recent_deposit||0));

            if (sortType === "deposit_asc")
                return items.sort((a,b)=> (a.recent_deposit||0)-(b.recent_deposit||0));

            if (sortType === "monthly_desc")
                return items.sort((a,b)=> (b.recent_monthly||0)-(a.recent_monthly||0));

            if (sortType === "monthly_asc")
                return items.sort((a,b)=> (a.recent_monthly||0)-(b.recent_monthly||0));

            return items;
        }

        /*************************************************
         * ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ (ì§€ë„ ì—°ë™)
         *************************************************/
        const listBody = document.getElementById("listBody");
        const listCount = document.getElementById("listCount");

        function renderList(items) {
            listBody.innerHTML = "";
            listCount.textContent = items.length.toString();

            // ê¸°ì¡´ ì¹´ë“œ ë§¤í•‘ ì´ˆê¸°í™”
            for (let key in cardByIdx) {
                delete cardByIdx[key];
            }

            items.forEach(p => {
                const card = document.createElement("div");
                card.className = "property-card";
                card.dataset.idx = p.idx;

                const price =
                    p.lease_type === "ì „ì„¸"
                        ? `ì „ì„¸ ${p.recent_deposit || '-'}`
                        : `ë³´ì¦ê¸ˆ ${p.recent_deposit || '-'} / ì›” ${p.recent_monthly || '-'}`;

                card.innerHTML = `
                    <div class="property-title-row">
                        <div class="property-title">${p.building_name}</div>
                        <div class="property-badge-wrap">
                            <span class="badge-chip lease">${p.lease_type}</span>
                            <span class="badge-chip type">${p.house_type}</span>
                        </div>
                    </div>
                    <div class="property-price">${price}</div>
                    <div class="property-meta">
                        <span>${p.district}</span>
                        <span>${p.floor}</span>
                        <span>${p.area_p}</span>
                        <span>${p.recent_yq}</span>
                    </div>
                    <div class="property-address">${p.jibun_address}</div>
                `;

                // ë¦¬ìŠ¤íŠ¸ì—ì„œ í´ë¦­ ì‹œ â†’ í•´ë‹¹ ë§ˆì»¤ ê°•ì¡° & ì§€ë„ ì´ë™ + íŒì—…
                card.addEventListener("click", () => {
                    selectByIdx(p.idx, true);
                });

                // í˜„ì¬ ì„ íƒëœ idxë¼ë©´ ê°•ì¡° ìœ ì§€
                if (selectedIdx === p.idx) {
                    card.classList.add("active");
                }

                cardByIdx[p.idx] = card;
                listBody.appendChild(card);
            });
        }

        /*************************************************
         * í´ëŸ¬ìŠ¤í„°/ë§ˆì»¤ í‘œì‹œ ì „í™˜ + ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
         *************************************************/
        function updateView() {
            const lv = map.getLevel();

            if (lv >= 6) {
                // ë™ í´ëŸ¬ìŠ¤í„° í‘œì‹œ, ê°œë³„ ë§ˆì»¤ ìˆ¨ê¹€
                dongOverlays.forEach(o => o.setMap(map));
                markers.forEach(m => m.setMap(null));
            } else {
                // ê°œë³„ ë§ˆì»¤ í‘œì‹œ, ë™ í´ëŸ¬ìŠ¤í„° ìˆ¨ê¹€
                dongOverlays.forEach(o => o.setMap(null));
                markers.forEach(m => m.setMap(map));
            }

            // ì§€ë„ í™”ë©´ ì•ˆì˜ ë§¤ë¬¼ë§Œ ë¦¬ìŠ¤íŠ¸ì— í‘œì‹œ
            let visible = getVisibleItems();
            visible = sortItems(visible);
            renderList(visible);
        }

        kakao.maps.event.addListener(map, "dragend", updateView);

        kakao.maps.event.addListener(map, "zoom_changed", () => {
            // ì¤Œ ì´ë²¤íŠ¸ ì‹œ: ê¸°ë³¸ì ìœ¼ë¡œ ì„ íƒ í•´ì œ
            if (suppressClearOnNextZoom) {
                // ìš°ë¦¬ ì½”ë“œê°€ ìœ ë„í•œ ì¤Œ(ë™ í´ë¦­, ë¦¬ìŠ¤íŠ¸ ì„ íƒ ë“±) â†’ ì´ë²ˆ í•œ ë²ˆì€ í•´ì œ ì•ˆ í•¨
                suppressClearOnNextZoom = false;
            } else {
                // ì‚¬ìš©ìê°€ ì§ì ‘ ì¤Œ ì¡°ì‘ â†’ ì„ íƒ í•´ì œ + íŒì—… ë‹«ê¸°
                clearSelection();
            }
            updateView();
        });

        // ì •ë ¬ ì„ íƒ ë³€ê²½ ì‹œ ë¦¬ìŠ¤íŠ¸ë§Œ ì¬ì •ë ¬ + ì¬ë Œë”
        document.getElementById("sortSelect").addEventListener("change", () => {
            updateView();
        });

        /*************************************************
         * ì´ˆê¸° ì‹¤í–‰
         *************************************************/
        createDongClusters();
        updateView();

    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const panel = document.getElementById("filterPanel");
        const btn = document.getElementById("filterToggleBtn");

        let isOpen = true;

        btn.addEventListener("click", () => {
            isOpen = !isOpen;

            if (isOpen) {
                panel.classList.remove("hidden");
                // ë²„íŠ¼ ì•ˆ í–„ë²„ê±° ìœ ì§€ â€” ì•„ë¬´ê²ƒë„ ë³€ê²½í•˜ì§€ ì•ŠìŒ
            } else {
                panel.classList.add("hidden");
                // ë²„íŠ¼ ì•ˆ í–„ë²„ê±° ìœ ì§€ â€” ì•„ë¬´ê²ƒë„ ë³€ê²½í•˜ì§€ ì•ŠìŒ
            }
        });
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const container = document.getElementById("filterContainer");
        const btn = document.getElementById("filterToggleBtn");

        let opened = true;

        btn.addEventListener("click", () => {
            opened = !opened;

            if (opened) {
                container.classList.remove("hidden");
                btn.classList.remove("active");   // ì•„ì´ì½˜ ì›ë˜ëŒ€ë¡œ
            } else {
                container.classList.add("hidden");
                btn.classList.add("active");      // ì•„ì´ì½˜ íšŒì „
            }
        });
    });
</script>

<!-- ğŸ”µ ì¡°íšŒì¤‘ ë¡œë”© ì˜¤ë²„ë ˆì´ -->
<div id="loadingOverlay" class="loading-overlay" style="display:none;">
    <div class="loading-box">
        <div class="spinner-border text-light" role="status"></div>
        <div class="loading-text">ì¡°íšŒì¤‘ì…ë‹ˆë‹¤...</div>
    </div>
</div>

</body>
</html>
