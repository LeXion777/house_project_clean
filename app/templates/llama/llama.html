<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <title>LLaMA3 Chat Playground</title>

    <!-- ‚úÖ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î∞îÍ∞Ä Bootstrap Í∏∞Î∞òÏù¥ÎØÄÎ°ú llama.htmlÏóêÏÑúÎßå Bootstrap Î°úÎìú -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        :root{
          /* =========================
             ‚úÖ MODERN "SOFT DARK" (ÎÑàÎ¨¥ Ïñ¥Îë°ÏßÄÎèÑ/Î∞ùÏßÄÎèÑ ÏïäÍ≤å)
             - ÎÑ§ÎπÑÎ∞îÎäî Í∑∏ÎåÄÎ°ú(ÏïÑÎûò 'predict-navbar' ÏÑπÏÖò ÏàòÏ†ï Í∏àÏßÄ)
          ========================= */
          --bg: #0f172a;
          --bg-2: #111c2f;
          --panel: rgba(17, 24, 39, 0.78);
          --panel-solid: #111827;
          --surface: rgba(255,255,255,0.06);
          --surface-2: rgba(255,255,255,0.08);
          --border: rgba(148,163,184,0.18);
          --border-2: rgba(148,163,184,0.26);
          --shadow: 0 14px 40px rgba(0,0,0,0.35);

          --text: #e5e7eb;
          --muted: #94a3b8;

          --brand: #ff6b00;
          --primary: #3b82f6;

          --assistant: rgba(148,163,184,0.12);
          --assistant-strong: rgba(148,163,184,0.16);

          --nav-h: 70px;
        }

        * { box-sizing: border-box; font-family: Pretendard, sans-serif; }
        html, body { margin:0; padding:0; height:100%; }

        body{
          color: var(--text);
          overflow: hidden;
          background:
            radial-gradient(1200px 700px at 18% 0%, rgba(255,107,0,0.10), transparent 60%),
            radial-gradient(900px 600px at 85% 15%, rgba(59,130,246,0.14), transparent 55%),
            linear-gradient(180deg, var(--bg) 0%, var(--bg-2) 100%);
        }

        .page-wrapper{
          height: 100vh;
          display: flex;
          flex-direction: column;
          overflow: hidden;
        }

        .app{
          height: calc(100vh - var(--nav-h));
          display: grid;
          grid-template-columns: 1fr 380px;
          overflow: hidden;
        }

        /* ===== LEFT ===== */
        .main{
          display:flex;
          flex-direction:column;
          height:100%;
          min-height:0;
          background: transparent;
        }

        header{
          padding: 12px 18px;
          border-bottom: 1px solid var(--border);
          font-weight: 900;
          display:flex;
          align-items:center;
          justify-content:space-between;
          gap:12px;
          min-height: 56px;
          background: linear-gradient(180deg, rgba(17,24,39,0.70) 0%, rgba(17,24,39,0.52) 100%);
          backdrop-filter: blur(10px);
        }

        .header-title{
          display:flex;
          align-items:center;
          gap:10px;
          min-width:0;
          white-space:nowrap;
          overflow:hidden;
          text-overflow:ellipsis;
          letter-spacing: -0.2px;
        }
        .header-title::before{
          content:"ü¶ô";
          opacity: 0.95;
        }

        .reset-chat-btn{
          padding: 8px 12px;
          border-radius: 999px;
          border: 1px solid rgba(248,113,113,0.45);
          background: rgba(248,113,113,0.10);
          color: #fecaca;
          cursor: pointer;
          font-weight: 800;
          font-size: 13px;
          line-height: 1;
          white-space: nowrap;
          transition: transform .12s ease, background .12s ease, border-color .12s ease;
        }
        .reset-chat-btn:hover{
          background: rgba(248,113,113,0.14);
          border-color: rgba(248,113,113,0.70);
          transform: translateY(-1px);
        }
        .reset-chat-btn:active{ transform: translateY(0px); }
        .reset-chat-btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

        .chat-wrapper{
          flex:1;
          min-height:0;
          overflow-y:auto;
          padding: 22px;
        }

        .chat{
          max-width: 920px;
          margin: 0 auto;
        }

        .msg{
          max-width: 75%;
          padding: 12px 16px;
          border-radius: 16px;
          margin-bottom: 14px;
          line-height: 1.65;
          white-space: pre-wrap;
          word-break: break-word;

          background: var(--surface);
          border: 1px solid var(--border);
          box-shadow: 0 10px 26px rgba(0,0,0,0.22);
        }

        .msg.user{
          margin-left:auto;
          background: linear-gradient(180deg, rgba(59,130,246,0.92), rgba(59,130,246,0.78));
          border-color: rgba(59,130,246,0.28);
          color:#fff;
        }

        .msg.assistant{
          margin-right:auto;
          background: linear-gradient(180deg, var(--assistant-strong), var(--assistant));
          border-color: var(--border);
          color: var(--text);
        }

        .msg.typing{
          margin-right:auto;
          background: linear-gradient(180deg, var(--assistant-strong), var(--assistant));
          color: var(--muted);
          font-style: italic;
        }

        .msg.typing::after{
          content:"...";
          animation: dots 1.2s infinite;
        }

        @keyframes dots{
          0% { content: "."; }
          33% { content: ".."; }
          66% { content: "..."; }
        }

        /* ===== Input ===== */
        .input-bar{
          border-top: 1px solid var(--border);
          padding: 14px 18px;
          background: linear-gradient(180deg, rgba(17,24,39,0.56) 0%, rgba(17,24,39,0.70) 100%);
          backdrop-filter: blur(10px);
        }

        .input-inner{
          max-width: 920px;
          margin: 0 auto;
          display:flex;
          gap: 10px;
          align-items: stretch;
        }

        textarea#prompt{
          flex:1;
          resize:none;
          padding: 12px 12px;
          border-radius: 14px;
          background: rgba(15,23,42,0.55);
          border: 1px solid var(--border);
          color: var(--text);
          outline: none;
          box-shadow: 0 10px 26px rgba(0,0,0,0.18);
        }
        textarea#prompt::placeholder{ color: rgba(148,163,184,0.85); }
        textarea#prompt:focus{
          border-color: rgba(59,130,246,0.55);
          box-shadow:
            0 14px 34px rgba(59,130,246,0.16),
            0 0 0 4px rgba(59,130,246,0.12);
          background: rgba(15,23,42,0.68);
        }

        button{
          padding: 0 20px;
          border-radius: 14px;
          border: 1px solid rgba(59,130,246,0.30);
          background: linear-gradient(180deg, rgba(59,130,246,0.95), rgba(59,130,246,0.78));
          color: #fff;
          cursor: pointer;
          font-weight: 900;
          box-shadow: 0 12px 28px rgba(59,130,246,0.18);
          transition: transform .12s ease, filter .12s ease;
        }
        button:hover{ filter: brightness(1.03); transform: translateY(-1px); }
        button:active{ transform: translateY(0px); }
        button:disabled{
          opacity: 0.55;
          cursor: not-allowed;
          box-shadow: none;
          transform: none;
        }

        /* ===== RIGHT SETTINGS ===== */
        .settings{
          background: linear-gradient(180deg, rgba(17,24,39,0.78) 0%, rgba(17,24,39,0.70) 100%);
          border-left: 1px solid var(--border);
          padding: 18px 18px 22px;
          overflow-y: auto;
          backdrop-filter: blur(10px);
        }

        .settings h3{
          margin-top: 0;
          margin-bottom: 10px;
          font-weight: 950;
          letter-spacing: -0.3px;
        }

        /* ‚úÖ Applied ÌòÑÌô©Ìåê */
        .applied-card{
          border: 1px solid var(--border);
          background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.05));
          border-radius: 16px;
          padding: 12px 12px;
          box-shadow: 0 12px 28px rgba(0,0,0,0.18);
          margin-bottom: 14px;
        }

        .applied-head{
          display:flex;
          align-items:center;
          justify-content:space-between;
          gap:10px;
          margin-bottom: 8px;
        }

        .applied-title{
          font-weight: 950;
          letter-spacing: -0.2px;
          display:flex;
          align-items:center;
          gap:8px;
        }

        .pill{
          font-size: 12px;
          font-weight: 900;
          padding: 5px 10px;
          border-radius: 999px;
          border: 1px solid rgba(59,130,246,0.30);
          background: rgba(59,130,246,0.10);
          color: #bfdbfe;
          white-space: nowrap;
        }

        .applied-meta{
          font-size: 12px;
          color: var(--muted);
          font-weight: 700;
          white-space: nowrap;
        }

        .applied-grid{
          display:grid;
          grid-template-columns: 1fr 1fr;
          gap: 8px 10px;
          margin-top: 10px;
        }

        .kv{
          border: 1px solid rgba(148,163,184,0.14);
          background: rgba(15,23,42,0.35);
          border-radius: 12px;
          padding: 10px 10px;
        }

        .k{
          font-size: 12px;
          color: var(--muted);
          font-weight: 800;
          margin-bottom: 3px;
        }
        .v{
          font-size: 13px;
          font-weight: 950;
          letter-spacing: -0.2px;
        }

        /* ‚úÖ System Prompt Applied: 2Ï§Ñ ÎßêÏ§ÑÏûÑ */
        .applied-prompt{
          margin-top: 8px;
          border: 1px solid rgba(255,107,0,0.22);
          background: rgba(255,107,0,0.06);
          border-radius: 14px;
          padding: 10px 10px;
        }
        .applied-prompt .k{
          color: rgba(255,220,200,0.85);
        }
        .applied-prompt .v{
          font-weight: 850;
          color: var(--text);
          display: -webkit-box;
          -webkit-line-clamp: 2;
          -webkit-box-orient: vertical;
          overflow: hidden;
          text-overflow: ellipsis;
          line-height: 1.35;
          max-height: calc(1.35em * 2);
          word-break: break-word;
        }

        .hint{
          margin-top: 8px;
          font-size: 12px;
          color: rgba(148,163,184,0.92);
          font-weight: 700;
        }

        .settings textarea[name="system_prompt"]{
          width: 100%;
          background: rgba(15,23,42,0.55) !important;
          color: var(--text) !important;
          border: 1px solid var(--border) !important;
          border-radius: 14px !important;
          padding: 10px 12px !important;
          outline: none !important;
        }
        .settings textarea[name="system_prompt"]:focus{
          border-color: rgba(255,107,0,0.60) !important;
          box-shadow: 0 0 0 4px rgba(255,107,0,0.14) !important;
          background: rgba(15,23,42,0.68) !important;
        }

        .param{ margin-bottom: 16px; }
        .param label{
          font-size: 13px;
          color: var(--muted);
          display:block;
          margin-bottom: 6px;
          font-weight: 750;
        }

        .param-row{
          display:flex;
          gap:10px;
          align-items:center;
        }

        .param-row input[type=range]{
          flex:1;
          accent-color: var(--primary);
        }

        .param-row input[type=number]{
          width: 78px;
          background: rgba(15,23,42,0.55);
          border: 1px solid var(--border);
          color: var(--text);
          border-radius: 12px;
          padding: 6px 8px;
          outline:none;
        }
        .param-row input[type=number]:focus{
          border-color: rgba(59,130,246,0.55);
          box-shadow: 0 0 0 4px rgba(59,130,246,0.12);
          background: rgba(15,23,42,0.68);
        }

        #resetParams{
          width: 100% !important;
          padding: 12px 10px !important;
          border-radius: 14px !important;
          border: 1px solid var(--border) !important;
          background: linear-gradient(180deg, rgba(148,163,184,0.10), rgba(148,163,184,0.06)) !important;
          color: var(--text) !important;
          cursor: pointer !important;
          margin-top: 12px !important;
          font-weight: 900 !important;
          box-shadow: 0 12px 26px rgba(0,0,0,0.18) !important;
        }
        #resetParams:hover{
          filter: brightness(1.03);
          transform: translateY(-1px);
        }

        .apply{
          width: 100%;
          padding: 12px 10px;
          border-radius: 14px;
          border: 1px solid rgba(255,107,0,0.28);
          background: linear-gradient(180deg, rgba(255,107,0,0.96), rgba(255,107,0,0.78));
          color: #fff;
          cursor: pointer;
          margin-top: 12px;
          font-weight: 950;
          box-shadow: 0 14px 30px rgba(255,107,0,0.18);
          transition: transform .12s ease, filter .12s ease;
        }
        .apply:hover{ filter: brightness(1.03); transform: translateY(-1px); }
        .apply:active{ transform: translateY(0px); }

        /* ===== OVERLAY ===== */
        .overlay{
          position: fixed;
          inset: 0;
          background: rgba(0,0,0,0.45);
          backdrop-filter: blur(2px);
          display: none;
          align-items: center;
          justify-content: center;
          z-index: 9999;
          pointer-events: all;
        }

        .overlay-box{
          background: rgba(17,24,39,0.92);
          border: 1px solid var(--border-2);
          color: var(--text);
          padding: 20px 26px;
          border-radius: 16px;
          font-size: 15px;
          font-weight: 900;
          box-shadow: var(--shadow);
          backdrop-filter: blur(10px);
        }

        /* ======================================
           ‚úÖ Ï†ÑÏõîÏÑ∏ ÏßÄÎèÑ ÌéòÏù¥ÏßÄ Ï†ÑÏö© ÎÑ§ÎπÑÍ≤åÏù¥ÏÖòÎ∞î CSS (Í≥µÏö©) - ÏàòÏ†ï Í∏àÏßÄ
        ====================================== */
        .predict-navbar {
          background: linear-gradient(90deg, #0b1d33, #0f2a52);
          height: var(--nav-h);
          padding: 0 2rem !important;
          border-bottom: none;
        }

        .predict-navbar .nav-link {
          color: #fff !important;
          font-weight: 500;
          font-size: 1rem;
          transition: color 0.25s ease, transform 0.25s ease;
          display: inline-block;
        }

        .predict-navbar .nav-link:hover {
          color: #ff6b00 !important;
          transform: translateY(-2px);
        }

        .predict-navbar .navbar-brand img {
          height: 40px;
          filter: brightness(1.1);
        }

        .predict-navbar .navbar-toggler {
          border-color: rgba(255,255,255,0.5);
        }

        .predict-navbar .navbar-toggler-icon {
          filter: brightness(200%);
        }

        .chat-wrapper::-webkit-scrollbar,
        .settings::-webkit-scrollbar { width: 10px; }

        .chat-wrapper::-webkit-scrollbar-thumb,
        .settings::-webkit-scrollbar-thumb{
          background: rgba(148,163,184,0.28);
          border-radius: 999px;
          border: 2px solid rgba(17,24,39,0.55);
        }

        .chat-wrapper::-webkit-scrollbar-track,
        .settings::-webkit-scrollbar-track{
          background: rgba(0,0,0,0);
        }

        @media (max-width: 992px){
          .app{ grid-template-columns: 1fr; }
          .settings{ display:none; }
        }
    </style>

    <script>
        /* =========================================================
           DEFAULT PRESET (Ï¥àÍ∏∞Í∞í)
        ========================================================= */
        const DEFAULT_PRESET = {
          temperature: 0.7,
          top_p: 0.9,
          top_k: 50,
          max_tokens: 512,
          repetition_penalty: 1.1
        };

        function scrollToBottom(wrapper) {
          requestAnimationFrame(() => { wrapper.scrollTop = wrapper.scrollHeight; });
        }

        function bindRangeNumber(rangeEl, numberEl) {
          if (!rangeEl || !numberEl) return;

          const min = Number(rangeEl.min);
          const max = Number(rangeEl.max);
          const step = Number(rangeEl.step || 1);

          const clampToStep = (val) => {
            if (Number.isNaN(val)) return Number(rangeEl.value);
            let v = Math.min(max, Math.max(min, val));
            const decimals = (String(step).split(".")[1] || "").length;
            const snapped = Math.round((v - min) / step) * step + min;
            return Number(snapped.toFixed(decimals));
          };

          const syncFromRange = () => { numberEl.value = rangeEl.value; };
          const syncFromNumber = () => {
            const v = clampToStep(Number(numberEl.value));
            rangeEl.value = String(v);
            numberEl.value = String(v);
          };

          rangeEl.addEventListener("input", syncFromRange);
          numberEl.addEventListener("input", () => {
            const raw = Number(numberEl.value);
            if (Number.isNaN(raw)) return;
            rangeEl.value = Math.min(max, Math.max(min, raw));
          });
          numberEl.addEventListener("change", syncFromNumber);
          numberEl.addEventListener("blur", syncFromNumber);

          syncFromRange();
        }

        function setOverlay(show, text) {
          const overlay = document.getElementById("overlay");
          const box = document.getElementById("overlayText");

          if (text) box.textContent = text;
          overlay.style.display = show ? "flex" : "none";

          if (show) {
            document.body.dataset.prevOverflow = document.body.style.overflow || "";
            document.body.style.overflow = "hidden";
          } else {
            document.body.style.overflow = document.body.dataset.prevOverflow || "";
            delete document.body.dataset.prevOverflow;
          }
        }

        function setParam(id, value) {
          const range = document.getElementById(id);
          const num = document.getElementById(id + "_num");
          if (!range || !num) return;
          range.value = value;
          num.value = value;
          range.dispatchEvent(new Event("input"));
        }

        function nowStamp() {
          const d = new Date();
          const yy = String(d.getFullYear()).slice(2);
          const mm = String(d.getMonth()+1).padStart(2,"0");
          const dd = String(d.getDate()).padStart(2,"0");
          const hh = String(d.getHours()).padStart(2,"0");
          const mi = String(d.getMinutes()).padStart(2,"0");
          return `${yy}.${mm}.${dd} ${hh}:${mi}`;
        }

        document.addEventListener("DOMContentLoaded", () => {
          /* =======================
             Elements
          ======================= */
          const textarea = document.getElementById("prompt");
          const sendBtn = document.getElementById("send");
          const resetChatBtn = document.getElementById("resetChat");
          const resetChatForm = document.getElementById("resetChatForm");

          const chat = document.querySelector(".chat");
          const wrapper = document.querySelector(".chat-wrapper");

          const systemPromptInput = document.getElementById("system_prompt_input");

          const temperature = document.getElementById("temperature");
          const temperature_num = document.getElementById("temperature_num");
          const top_p = document.getElementById("top_p");
          const top_p_num = document.getElementById("top_p_num");
          const top_k = document.getElementById("top_k");
          const top_k_num = document.getElementById("top_k_num");
          const max_tokens = document.getElementById("max_tokens");
          const max_tokens_num = document.getElementById("max_tokens_num");
          const repetition_penalty = document.getElementById("repetition_penalty");
          const repetition_penalty_num = document.getElementById("repetition_penalty_num");

          const applyBtn = document.getElementById("applyBtn");
          const appliedAtEl = document.getElementById("appliedAt");
          const appliedPromptEl = document.getElementById("appliedPromptText");

          const appliedTemperatureEl = document.getElementById("applied_temperature");
          const appliedTopPEl = document.getElementById("applied_top_p");
          const appliedTopKEl = document.getElementById("applied_top_k");
          const appliedMaxTokensEl = document.getElementById("applied_max_tokens");
          const appliedRepEl = document.getElementById("applied_repetition_penalty");

          scrollToBottom(wrapper);

          /* =======================
             Client-side applied state
             (‚úÖ ÏÑ∏ÏÖò/Ïø†ÌÇ§ Ï†ÄÏû• ÏóÜÏù¥ "ÌòÑÏû¨ Ï†ÅÏö©Í∞í"Îßå Í¥ÄÎ¶¨)
          ======================= */
          let applied = {
            system_prompt: (systemPromptInput.value || "").trim(),
            temperature: Number(temperature.value),
            top_p: Number(top_p.value),
            top_k: Number(top_k.value),
            max_tokens: Number(max_tokens.value),
            repetition_penalty: Number(repetition_penalty.value),
            applied_at: "Í∏∞Î≥∏Í∞í"
          };

          function updateAppliedBoard() {
            appliedAtEl.textContent = applied.applied_at;

            const sp = (applied.system_prompt || "").trim();
            appliedPromptEl.textContent = sp.length ? sp : "(ÎπÑÏñ¥ÏûàÏùå)";

            appliedTemperatureEl.textContent = String(applied.temperature);
            appliedTopPEl.textContent = String(applied.top_p);
            appliedTopKEl.textContent = String(applied.top_k);
            appliedMaxTokensEl.textContent = String(applied.max_tokens);
            appliedRepEl.textContent = String(applied.repetition_penalty);
          }

          // ÏµúÏ¥à 1Ìöå: ÌòÑÏû¨ ÌôîÎ©¥ Í∞í = Í∏∞Î≥∏Í∞í ‚Üí ÌòÑÌô©Ìåê Î∞òÏòÅ
          updateAppliedBoard();

          /* =======================
             Send enable/disable
          ======================= */
          sendBtn.disabled = true;
          textarea.addEventListener("input", () => {
            sendBtn.disabled = textarea.value.trim() === "";
          });

          textarea.addEventListener("keydown", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
              e.preventDefault();
              if (!sendBtn.disabled) sendBtn.click();
            }
          });

          /* =======================
             Hyper Parameter Sync
          ======================= */
          bindRangeNumber(temperature, temperature_num);
          bindRangeNumber(top_p, top_p_num);
          bindRangeNumber(top_k, top_k_num);
          bindRangeNumber(max_tokens, max_tokens_num);
          bindRangeNumber(repetition_penalty, repetition_penalty_num);

          /* =======================
             Reset Params (ÏûÖÎ†•Í∞íÎßå Ï¥àÍ∏∞Ìôî / Ï†ÅÏö©ÏùÄ ApplyÎ•º ÎàåÎü¨Ïïº Î∞òÏòÅ)
          ======================= */
          const resetParamsBtn = document.getElementById("resetParams");
          resetParamsBtn.addEventListener("click", () => {
            setParam("temperature", DEFAULT_PRESET.temperature);
            setParam("top_p", DEFAULT_PRESET.top_p);
            setParam("top_k", DEFAULT_PRESET.top_k);
            setParam("max_tokens", DEFAULT_PRESET.max_tokens);
            setParam("repetition_penalty", DEFAULT_PRESET.repetition_penalty);
          });

          /* =======================
             ‚úÖ Apply Settings (ÏÑúÎ≤Ñ/ÏÑ∏ÏÖò Ï†ÄÏû• X)
             - "ÌòÑÏû¨ Ï†ÅÏö©Í∞í(applied)"Îßå Í∞±Ïã† + ÌòÑÌô©Ìåê ÏóÖÎç∞Ïù¥Ìä∏
          ======================= */
          applyBtn.addEventListener("click", () => {
            setOverlay(true, "ÌîÑÎ°¨ÌîÑÌä∏&ÌïòÏù¥ÌçºÌååÎùºÎØ∏ÌÑ∞ Ï†ÅÏö©Ï§ëÏûÖÎãàÎã§‚Ä¶");

            // ÏïÑÏ£º ÏßßÍ≤åÎßå Ïû†Í∏à(UXÏö©). Ïã§Ï†úÎ°ú ÏÑúÎ≤Ñ Ï†ÄÏû•ÏùÑ Ïïà ÌïòÎãà Ï¶âÏãú Î∞òÏòÅ.
            requestAnimationFrame(() => {
              applied = {
                system_prompt: (systemPromptInput.value || "").trim(),
                temperature: Number(temperature.value),
                top_p: Number(top_p.value),
                top_k: Number(top_k.value),
                max_tokens: Number(max_tokens.value),
                repetition_penalty: Number(repetition_penalty.value),
                applied_at: nowStamp()
              };

              updateAppliedBoard();
              setOverlay(false);
            });
          });

          /* =======================
             Chat Send (JSON)
             ‚úÖ Ï†ÅÏö©Îêú(applied) Í∞íÏùÑ Îß§ ÏöîÏ≤≠ÎßàÎã§ Í∞ôÏù¥ Ï†ÑÏÜ°
          ======================= */
          let isSending = false;
          let isResetting = false;

          sendBtn.addEventListener("click", async () => {
            if (isSending || isResetting) return;

            const text = textarea.value.trim();
            if (!text) return;

            isSending = true;

            const userMsg = document.createElement("div");
            userMsg.className = "msg user";
            userMsg.innerText = text;
            chat.appendChild(userMsg);

            const typing = document.createElement("div");
            typing.className = "msg assistant typing";
            typing.innerText = "";
            chat.appendChild(typing);

            scrollToBottom(wrapper);

            textarea.value = "";
            textarea.disabled = true;
            sendBtn.disabled = true;
            resetChatBtn.disabled = true;

            try {
              const payload = {
                prompt: text,
                system_prompt: applied.system_prompt,
                temperature: applied.temperature,
                top_p: applied.top_p,
                top_k: applied.top_k,
                max_tokens: applied.max_tokens,
                repetition_penalty: applied.repetition_penalty
              };

              const res = await fetch("/llama", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(payload)
              });

              if (!res.ok) throw new Error("HTTP " + res.status);

              const ct = res.headers.get("content-type") || "";
              if (!ct.includes("application/json")) throw new Error("Invalid response type");

              const data = await res.json();

              typing.remove();

              const botMsg = document.createElement("div");
              botMsg.className = "msg assistant";
              botMsg.innerText = (data && data.answer) ? data.answer : "(Îπà ÏùëÎãµ)";
              chat.appendChild(botMsg);

              scrollToBottom(wrapper);
            } catch (err) {
              typing.remove();

              const errMsg = document.createElement("div");
              errMsg.className = "msg assistant";
              errMsg.innerText = "‚ö†Ô∏è Ïò§Î•ò Î∞úÏÉù\n" + err;
              chat.appendChild(errMsg);

              scrollToBottom(wrapper);
            } finally {
              textarea.disabled = false;
              textarea.focus();
              isSending = false;

              sendBtn.disabled = true;
              resetChatBtn.disabled = false;
            }
          });

          /* =======================
             Chat Reset (FORM)
          ======================= */
          resetChatBtn.addEventListener("click", () => {
            if (isSending || isResetting) return;

            const ok = confirm("ÎåÄÌôî ÎÇ¥Ïó≠ÏùÑ Î™®Îëê Ï¥àÍ∏∞ÌôîÌï†ÍπåÏöî?\n(ÏÉàÎ°úÍ≥†Ïπ®Ìï¥ÎèÑ Î≥µÍµ¨ÎêòÏßÄ ÏïäÏäµÎãàÎã§)");
            if (!ok) return;

            isResetting = true;

            textarea.disabled = true;
            sendBtn.disabled = true;
            resetChatBtn.disabled = true;

            setOverlay(true, "ÎåÄÌôî Ï¥àÍ∏∞ÌôîÏ§ëÏûÖÎãàÎã§‚Ä¶");
            resetChatForm.submit();
          });

          /* =======================
             overlay Ïû†Í∏à
          ======================= */
          const overlay = document.getElementById("overlay");
          overlay.addEventListener("click", (e) => e.preventDefault());
          overlay.addEventListener("wheel", (e) => e.preventDefault(), { passive: false });
          document.addEventListener("keydown", (e) => {
            if (overlay.style.display === "flex") e.preventDefault();
          }, { capture: true });

          /* =======================
             ‚úÖ paramForm submit Î∞©ÏßÄ
             (EnterÎ°ú submitÎêòÎäî ÏÇ¨Í≥† Î∞©ÏßÄ)
          ======================= */
          const paramForm = document.getElementById("paramForm");
          paramForm.addEventListener("submit", (e) => {
            e.preventDefault();
          });
        });
    </script>
</head>

<body>
<div class="overlay" id="overlay">
    <div class="overlay-box" id="overlayText">ÌîÑÎ°¨ÌîÑÌä∏&ÌïòÏù¥ÌçºÌååÎùºÎØ∏ÌÑ∞ Ï†ÅÏö©Ï§ëÏûÖÎãàÎã§‚Ä¶</div>
</div>

<div class="page-wrapper">

    <!-- ‚úÖ NAVIGATION BAR (Í≥µÏö©) - ÏàòÏ†ï Í∏àÏßÄ -->
    <nav class="navbar navbar-expand-lg predict-navbar">
        <div class="container-fluid px-4">

            <a class="navbar-brand" href="{{ url_for('index.index') }}">
                <img src="{{ url_for('static', filename='image/logo2.png') }}"
                     alt="Ï≤≠ÎÖÑ Ï£ºÍ±∞ ÏÜîÎ£®ÏÖò Î°úÍ≥†"
                     style="height:40px; width:auto;">
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#topNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="topNav">
                <ul class="navbar-nav ms-auto align-items-center">
                    <li class="nav-item ms-3"><a class="nav-link" href="{{ url_for('predict.predict_search') }}">Ï†ÑÏõîÏÑ∏
                        ÏòàÏ∏°</a></li>
                    <li class="nav-item ms-3"><a class="nav-link"
                                                 href="{{ url_for('support.support_search') }}">Ï†ïÎ∂ÄÏßÄÏõê</a></li>
                    <li class="nav-item ms-3"><a class="nav-link" href="{{ url_for('login.login') }}">Î°úÍ∑∏Ïù∏</a></li>
                    <li class="nav-item ms-3"><a class="nav-link" href="{{ url_for('login.signup') }}">ÌöåÏõêÍ∞ÄÏûÖ</a></li>
                </ul>
            </div>

        </div>
    </nav>

    <!-- ‚úÖ llama Ïï± -->
    <div class="app">

        <!-- LEFT -->
        <div class="main">
            <header>
                <div class="header-title">LLaMA3 8B Chat</div>

                <button id="resetChat" type="button" class="reset-chat-btn">Reset Chat</button>

                <form id="resetChatForm" method="post" style="display:none;">
                    <input type="hidden" name="action" value="reset_chat">
                </form>
            </header>

            <div class="chat-wrapper">
                <div class="chat">
                    {% for msg in chat_history %}
                    <div class="msg {{ msg.role }}">{{ msg.content }}</div>
                    {% endfor %}
                </div>
            </div>

            <div class="input-bar">
                <div class="input-inner">
                    <textarea id="prompt" rows="2" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."></textarea>
                    <button id="send" type="button">Send</button>
                </div>
            </div>
        </div>

        <!-- RIGHT -->
        <form id="paramForm" class="settings" autocomplete="off">
            <!-- ‚úÖ Applied ÌòÑÌô©Ìåê -->
            <div class="applied-card">
                <div class="applied-head">
                    <div class="applied-title">
                        Applied Status
                        <span class="pill">ACTIVE</span>
                    </div>
                    <div class="applied-meta">Last: <span id="appliedAt">-</span></div>
                </div>

                <div class="applied-prompt">
                    <div class="k">System Prompt (Applied)</div>
                    <div class="v" id="appliedPromptText">(ÎπÑÏñ¥ÏûàÏùå)</div>
                </div>

                <div class="applied-grid">
                    <div class="kv">
                        <div class="k">Temperature</div>
                        <div class="v" id="applied_temperature">-</div>
                    </div>
                    <div class="kv">
                        <div class="k">Top-p</div>
                        <div class="v" id="applied_top_p">-</div>
                    </div>
                    <div class="kv">
                        <div class="k">Top-k</div>
                        <div class="v" id="applied_top_k">-</div>
                    </div>
                    <div class="kv">
                        <div class="k">Max Tokens</div>
                        <div class="v" id="applied_max_tokens">-</div>
                    </div>
                    <div class="kv" style="grid-column: 1 / -1;">
                        <div class="k">Repetition Penalty</div>
                        <div class="v" id="applied_repetition_penalty">-</div>
                    </div>
                </div>

                <div class="hint">‚Äª Send ÏöîÏ≤≠ÏóêÎäî Ìï≠ÏÉÅ ‚ÄúApplied Status‚Äù Í∞íÏù¥ Ìè¨Ìï®ÎêòÏñ¥ Ï†ÑÏÜ°Îê©ÎãàÎã§.</div>
            </div>

            <!-- ‚úÖ ÏûÖÎ†• ÏòÅÏó≠(Í∏∞Ï°¥) -->
            <h3>System Prompt</h3>
            <textarea id="system_prompt_input" name="system_prompt" rows="4">{{ system_prompt }}</textarea>

            <h3 style="margin-top:16px;">Hyper Parameters</h3>

            <div class="param">
                <label>Temperature (ÎûúÎç§ÏÑ±)</label>
                <div class="param-row">
                    <input id="temperature" type="range" min="0.1" max="1.5" step="0.1"
                           value="{{ params.temperature }}">
                    <input id="temperature_num" name="temperature" type="number" min="0.1" max="1.5" step="0.1"
                           value="{{ params.temperature }}">
                </div>
            </div>

            <div class="param">
                <label>Top-p (Nucleus Sampling)</label>
                <div class="param-row">
                    <input id="top_p" type="range" min="0.1" max="1" step="0.05" value="{{ params.top_p }}">
                    <input id="top_p_num" name="top_p" type="number" min="0.1" max="1" step="0.05"
                           value="{{ params.top_p }}">
                </div>
            </div>

            <div class="param">
                <label>Top-k (ÌôïÎ•† ÏÉÅÏúÑ kÍ∞ú ÌÜ†ÌÅ∞)</label>
                <div class="param-row">
                    <input id="top_k" type="range" min="0" max="100" step="1" value="{{ params.top_k }}">
                    <input id="top_k_num" name="top_k" type="number" min="0" max="100" step="1"
                           value="{{ params.top_k }}">
                </div>
            </div>

            <div class="param">
                <label>Max Tokens (ÏùëÎãµ Í∏∏Ïù¥ ÏÉÅÌïú)</label>
                <div class="param-row">
                    <input id="max_tokens" type="range" min="32" max="2048" step="32" value="{{ params.max_tokens }}">
                    <input id="max_tokens_num" name="max_tokens" type="number" min="32" max="2048" step="32"
                           value="{{ params.max_tokens }}">
                </div>
            </div>

            <div class="param">
                <label>Repetition Penalty (Ï§ëÎ≥µ ÏñµÏ†ú)</label>
                <div class="param-row">
                    <input id="repetition_penalty" type="range" min="1" max="1.5" step="0.05"
                           value="{{ params.repetition_penalty }}">
                    <input id="repetition_penalty_num" name="repetition_penalty" type="number" min="1" max="1.5"
                           step="0.05" value="{{ params.repetition_penalty }}">
                </div>
            </div>

            <button type="button" id="resetParams"
                    style="width:100%; padding:10px; border-radius:8px;
                       border:1px solid #1e293b; background:#334155;
                       color:white; cursor:pointer; margin-top:12px;">
                Reset to Default
            </button>

            <!-- ‚úÖ ApplyÎäî submitÏù¥ ÏïÑÎãàÎùº "ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ï†ÅÏö©" Î≤ÑÌäº -->
            <button id="applyBtn" class="apply" type="button">Apply Settings</button>
        </form>

    </div>
</div>
</body>
</html>
