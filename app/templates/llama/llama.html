{% extends "layout.html" %}

{% block title %}LLaMA3 Chat Playground{% endblock %}
{% block main_class %}llama-main{% endblock %}

{% block page_css %}
<style>
    /* ===========================
       llama ÌéòÏù¥ÏßÄ CSSÎäî nav/footerÏóê ÏòÅÌñ• Ï£ºÎ©¥ Ïïà Îê®
       -> .llama-root ÏïàÏóêÏÑúÎßå Ï†ÅÏö© (Í∏∞Îä•ÏùÄ ÎèôÏùº)
    =========================== */

    .llama-main { padding: 0 !important; }

    .llama-root {
        --bg: #0b1020;
        --panel: #020617;
        --primary: #2563eb;
        --assistant: #1e293b;
        --text: #e5e7eb;
        --muted: #94a3b8;

        background: var(--bg);
        color: var(--text);

        /* Í∏∞Ï°¥ body 100vh/overflow hidden ÎäêÎÇåÏùÑ Ïª®ÌÖåÏù¥ÎÑàÎ°ú Ïù¥Îèô */
        height: 100vh;
        overflow: hidden;
    }

    .llama-root * { box-sizing: border-box; font-family: Pretendard, sans-serif; }

    .llama-root .app {
        display: grid;
        grid-template-columns: 1fr 380px;
        height: 100%;
    }

    /* ===== LEFT ===== */
    .llama-root .main {
        display: flex;
        flex-direction: column;
        height: 100%;
        min-height: 0;
    }

    .llama-root header {
        padding: 14px 24px;
        background: var(--panel);
        border-bottom: 1px solid #1e293b;
        font-weight: bold;
    }

    .llama-root .chat-wrapper {
        flex: 1;
        min-height: 0;
        overflow-y: auto;
        padding: 24px;
    }

    .llama-root .chat {
        max-width: 900px;
        margin: 0 auto;
    }

    .llama-root .msg {
        max-width: 75%;
        padding: 12px 16px;
        border-radius: 14px;
        margin-bottom: 14px;
        line-height: 1.6;
        white-space: pre-wrap;
        word-break: break-word;
    }

    .llama-root .msg.user {
        background: var(--primary);
        margin-left: auto;
    }

    .llama-root .msg.assistant {
        background: var(--assistant);
        margin-right: auto;
    }

    .llama-root .msg.typing {
        background: var(--assistant);
        color: var(--muted);
        font-style: italic;
    }

    .llama-root .msg.typing::after {
        content: "...";
        animation: llama-dots 1.2s infinite;
    }

    @keyframes llama-dots {
        0% { content: "."; }
        33% { content: ".."; }
        66% { content: "..."; }
    }

    /* Input */
    .llama-root .input-bar {
        border-top: 1px solid #1e293b;
        background: var(--panel);
        padding: 14px 24px;
    }

    .llama-root .input-inner {
        max-width: 900px;
        margin: 0 auto;
        display: flex;
        gap: 10px;
    }

    .llama-root textarea#prompt {
        flex: 1;
        resize: none;
        padding: 12px;
        border-radius: 10px;
        background: var(--panel);
        border: 1px solid #1e293b;
        color: var(--text);
    }

    .llama-root button {
        padding: 0 20px;
        border-radius: 10px;
        border: none;
        background: var(--primary);
        color: white;
        cursor: pointer;
    }

    .llama-root button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* ===== RIGHT SETTINGS ===== */
    .llama-root .settings {
        background: var(--panel);
        border-left: 1px solid #1e293b;
        padding: 20px;
        overflow-y: auto;
    }

    .llama-root .settings h3 { margin-top: 0; }

    .llama-root .param { margin-bottom: 16px; }

    .llama-root .param label {
        font-size: 13px;
        color: var(--muted);
        display: block;
        margin-bottom: 6px;
    }

    .llama-root .param-row {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .llama-root .param-row input[type=range] { flex: 1; }

    .llama-root .param-row input[type=number] {
        width: 76px;
        background: var(--panel);
        border: 1px solid #1e293b;
        color: var(--text);
        border-radius: 6px;
        padding: 6px 6px;
    }

    .llama-root .apply {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: none;
        background: #16a34a;
        color: white;
        cursor: pointer;
        margin-top: 12px;
    }

    /* ===== OVERLAY (Apply Ï§ë Ïû†Í∏à) ===== */
    .llama-root .overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.6);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        pointer-events: all;
    }

    .llama-root .overlay-box {
        background: var(--panel);
        padding: 24px 32px;
        border-radius: 12px;
        font-size: 16px;
        border: 1px solid #1e293b;
    }
</style>
{% endblock %}

{% block content %}
<div class="llama-root">

    <div class="overlay" id="overlay">
        <div class="overlay-box" id="overlayText">ÌïòÏù¥ÌçºÌååÎùºÎØ∏ÌÑ∞ Ï†ÅÏö©Ï§ëÏûÖÎãàÎã§‚Ä¶</div>
    </div>

    <div class="app">

        <!-- LEFT -->
        <div class="main">
            <header>ü¶ô LLaMA3 8B Chat Playground</header>

            <div class="chat-wrapper">
                <div class="chat">
                    {% for msg in chat_history %}
                    <div class="msg {{ msg.role }}">{{ msg.content }}</div>
                    {% endfor %}
                </div>
            </div>

            <div class="input-bar">
                <div class="input-inner">
                    <textarea id="prompt" rows="2" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."></textarea>
                    <button id="send">Send</button>
                </div>
            </div>
        </div>

        <!-- RIGHT -->
        <form id="paramForm" method="post" class="settings">
            <h3>System Prompt</h3>
            <textarea name="system_prompt" rows="4" style="width:100%">{{ system_prompt }}</textarea>

            <h3>Hyper Parameters</h3>

            <div class="param">
                <label>Temperature (ÎûúÎç§ÏÑ±)</label>
                <div class="param-row">
                    <input id="temperature" type="range" min="0.1" max="1.5" step="0.1"
                           value="{{ params.temperature }}">
                    <input id="temperature_num" name="temperature" type="number" min="0.1" max="1.5" step="0.1"
                           value="{{ params.temperature }}">
                </div>
            </div>

            <div class="param">
                <label>Top-p (Nucleus Sampling)</label>
                <div class="param-row">
                    <input id="top_p" type="range" min="0.1" max="1" step="0.05" value="{{ params.top_p }}">
                    <input id="top_p_num" name="top_p" type="number" min="0.1" max="1" step="0.05"
                           value="{{ params.top_p }}">
                </div>
            </div>

            <div class="param">
                <label>Top-k (ÌôïÎ•† ÏÉÅÏúÑ kÍ∞ú ÌÜ†ÌÅ∞)</label>
                <div class="param-row">
                    <input id="top_k" type="range" min="0" max="100" step="1" value="{{ params.top_k }}">
                    <input id="top_k_num" name="top_k" type="number" min="0" max="100" step="1"
                           value="{{ params.top_k }}">
                </div>
            </div>

            <div class="param">
                <label>Max Tokens (ÏùëÎãµ Í∏∏Ïù¥ ÏÉÅÌïú)</label>
                <div class="param-row">
                    <input id="max_tokens" type="range" min="32" max="2048" step="32" value="{{ params.max_tokens }}">
                    <input id="max_tokens_num" name="max_tokens" type="number" min="32" max="2048" step="32"
                           value="{{ params.max_tokens }}">
                </div>
            </div>

            <div class="param">
                <label>Repetition Penalty (Ï§ëÎ≥µ ÏñµÏ†ú)</label>
                <div class="param-row">
                    <input id="repetition_penalty" type="range" min="1" max="1.5" step="0.05"
                           value="{{ params.repetition_penalty }}">
                    <input id="repetition_penalty_num" name="repetition_penalty" type="number" min="1" max="1.5"
                           step="0.05"
                           value="{{ params.repetition_penalty }}">
                </div>
            </div>

            <input type="hidden" name="action" value="apply_params">

            <button type="button" id="resetParams"
                    style="width:100%; padding:10px; border-radius:8px;
                   border:1px solid #1e293b; background:#334155;
                   color:white; cursor:pointer; margin-top:12px;">
                Reset to Default
            </button>

            <button class="apply" type="submit">Apply Settings</button>
        </form>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    /* =========================================================
       DEFAULT PRESET (Ï¥àÍ∏∞Í∞í)
    ========================================================= */
    const DEFAULT_PRESET = {
        temperature: 0.7,
        top_p: 0.9,
        top_k: 50,
        max_tokens: 512,
        repetition_penalty: 1.1
    };

    /* =========================================================
       Utility
    ========================================================= */
    function scrollToBottom(wrapper) {
        requestAnimationFrame(() => {
            wrapper.scrollTop = wrapper.scrollHeight;
        });
    }

    // range <-> number ÎèôÍ∏∞Ìôî (ÏñëÎ∞©Ìñ• + clamp)
    function bindRangeNumber(rangeEl, numberEl) {
        if (!rangeEl || !numberEl) return;

        const min = Number(rangeEl.min);
        const max = Number(rangeEl.max);
        const step = Number(rangeEl.step || 1);

        const clampToStep = (val) => {
            if (Number.isNaN(val)) return Number(rangeEl.value);
            let v = Math.min(max, Math.max(min, val));
            const decimals = (String(step).split(".")[1] || "").length;
            const snapped = Math.round((v - min) / step) * step + min;
            return Number(snapped.toFixed(decimals));
        };

        const syncFromRange = () => {
            numberEl.value = rangeEl.value;
        };

        const syncFromNumber = () => {
            const v = clampToStep(Number(numberEl.value));
            rangeEl.value = String(v);
            numberEl.value = String(v);
        };

        rangeEl.addEventListener("input", syncFromRange);
        numberEl.addEventListener("input", () => {
            const raw = Number(numberEl.value);
            if (Number.isNaN(raw)) return;
            rangeEl.value = Math.min(max, Math.max(min, raw));
        });
        numberEl.addEventListener("change", syncFromNumber);
        numberEl.addEventListener("blur", syncFromNumber);

        syncFromRange();
    }

    // overlay ÌëúÏãú/Ïà®ÍπÄ + Ï†ÑÏ≤¥ UI Ïû†Í∏à
    function setOverlay(show, text) {
        const overlay = document.getElementById("overlay");
        const box = document.getElementById("overlayText");

        if (text) box.textContent = text;
        overlay.style.display = show ? "flex" : "none";

        if (show) {
            document.body.dataset.prevOverflow = document.body.style.overflow || "";
            document.body.style.overflow = "hidden";
        } else {
            document.body.style.overflow = document.body.dataset.prevOverflow || "";
            delete document.body.dataset.prevOverflow;
        }
    }

    // ÌååÎùºÎØ∏ÌÑ∞ Í∞í ÏÑ∏ÌåÖ (range + number ÎèôÏãúÏóê)
    function setParam(id, value) {
        const range = document.getElementById(id);
        const num = document.getElementById(id + "_num");
        if (!range || !num) return;

        range.value = value;
        num.value = value;
        range.dispatchEvent(new Event("input"));
    }

    /* =========================================================
       DOMContentLoaded
    ========================================================= */
    document.addEventListener("DOMContentLoaded", () => {

        /* =======================
           Chat Elements
        ======================= */
        const textarea = document.getElementById("prompt");
        const sendBtn = document.getElementById("send");
        const chat = document.querySelector(".chat");
        const wrapper = document.querySelector(".chat-wrapper");

        scrollToBottom(wrapper);

        sendBtn.disabled = true;
        textarea.addEventListener("input", () => {
            sendBtn.disabled = textarea.value.trim() === "";
        });

        textarea.addEventListener("keydown", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                if (!sendBtn.disabled) sendBtn.click();
            }
        });

        /* =======================
           Chat Send
        ======================= */
        let isSending = false;

        sendBtn.addEventListener("click", async () => {
            if (isSending) return;

            const text = textarea.value.trim();
            if (!text) return;

            isSending = true;

            const userMsg = document.createElement("div");
            userMsg.className = "msg user";
            userMsg.innerText = text;
            chat.appendChild(userMsg);

            const typing = document.createElement("div");
            typing.className = "msg assistant typing";
            chat.appendChild(typing);

            scrollToBottom(wrapper);

            textarea.value = "";
            textarea.disabled = true;
            sendBtn.disabled = true;

            try {
                const res = await fetch("/llama", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ prompt: text })
                });

                if (!res.ok) throw new Error("HTTP " + res.status);

                const ct = res.headers.get("content-type") || "";
                if (!ct.includes("application/json")) {
                    throw new Error("Invalid response type");
                }

                const data = await res.json();
                typing.remove();

                const botMsg = document.createElement("div");
                botMsg.className = "msg assistant";
                botMsg.innerText = data.answer || "(Îπà ÏùëÎãµ)";
                chat.appendChild(botMsg);

                scrollToBottom(wrapper);

            } catch (err) {
                typing.remove();
                const errMsg = document.createElement("div");
                errMsg.className = "msg assistant";
                errMsg.innerText = "‚ö†Ô∏è Ïò§Î•ò Î∞úÏÉù\n" + err;
                chat.appendChild(errMsg);
                scrollToBottom(wrapper);
            } finally {
                textarea.disabled = false;
                textarea.focus();
                isSending = false;
                sendBtn.disabled = true;
            }
        });

        /* =======================
           Hyper Parameter Sync
        ======================= */
        bindRangeNumber(temperature, temperature_num);
        bindRangeNumber(top_p, top_p_num);
        bindRangeNumber(top_k, top_k_num);
        bindRangeNumber(max_tokens, max_tokens_num);
        bindRangeNumber(repetition_penalty, repetition_penalty_num);

        /* =======================
           Reset Button
        ======================= */
        const resetBtn = document.getElementById("resetParams");
        resetBtn.addEventListener("click", () => {
            setParam("temperature", DEFAULT_PRESET.temperature);
            setParam("top_p", DEFAULT_PRESET.top_p);
            setParam("top_k", DEFAULT_PRESET.top_k);
            setParam("max_tokens", DEFAULT_PRESET.max_tokens);
            setParam("repetition_penalty", DEFAULT_PRESET.repetition_penalty);
        });

        /* =======================
           Apply Params Overlay
        ======================= */
        const paramForm = document.getElementById("paramForm");
        paramForm.addEventListener("submit", () => {
            setOverlay(true, "ÌïòÏù¥ÌçºÌååÎùºÎØ∏ÌÑ∞ Ï†ÅÏö©Ï§ëÏûÖÎãàÎã§‚Ä¶");
        });

        const overlay = document.getElementById("overlay");
        overlay.addEventListener("click", (e) => e.preventDefault());
        overlay.addEventListener("wheel", (e) => e.preventDefault(), { passive: false });
        document.addEventListener("keydown", (e) => {
            if (overlay.style.display === "flex") e.preventDefault();
        }, { capture: true });
    });
</script>
{% endblock %}
