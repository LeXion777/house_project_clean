<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <title>LLaMA3 Chat Playground</title>

    <!-- Bootstrap (Í∏∞Ï°¥ Ïú†ÏßÄ) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        :root{
          /* =========================
             MODERN "SOFT DARK"
             - ÎÑ§ÎπÑÎ∞îÎäî Í∑∏ÎåÄÎ°ú(ÏïÑÎûò 'predict-navbar' ÏÑπÏÖò ÏàòÏ†ï Í∏àÏßÄ)
          ========================= */
          --bg: #0f172a;
          --bg-2: #111c2f;
          --panel: rgba(17, 24, 39, 0.78);
          --panel-solid: #111827;
          --surface: rgba(255,255,255,0.06);
          --surface-2: rgba(255,255,255,0.08);
          --border: rgba(148,163,184,0.18);
          --border-2: rgba(148,163,184,0.26);
          --shadow: 0 14px 40px rgba(0,0,0,0.35);

          --text: #e5e7eb;
          --muted: #94a3b8;

          --brand: #ff6b00;
          --primary: #3b82f6;

          --assistant: rgba(148,163,184,0.12);
          --assistant-strong: rgba(148,163,184,0.16);

          --nav-h: 70px;
        }

        * { box-sizing: border-box; font-family: Pretendard, sans-serif; }
        html, body { margin:0; padding:0; height:100%; }

        body{
          color: var(--text);
          overflow: hidden;
          background:
            radial-gradient(1200px 700px at 18% 0%, rgba(255,107,0,0.10), transparent 60%),
            radial-gradient(900px 600px at 85% 15%, rgba(59,130,246,0.14), transparent 55%),
            linear-gradient(180deg, var(--bg) 0%, var(--bg-2) 100%);
        }

        .page-wrapper{
          height: 100vh;
          display: flex;
          flex-direction: column;
          overflow: hidden;
        }

        .app{
          height: calc(100vh - var(--nav-h));
          display: grid;
          grid-template-columns: 1fr 410px; /* Ïò§Î•∏Ï™Ω ÏÑ§Ï†ïÌå®ÎÑê ÏÇ¥Ïßù ÌôïÏû• */
          overflow: hidden;
        }

        /* ===== LEFT ===== */
        .main{
          display:flex;
          flex-direction:column;
          height:100%;
          min-height:0;
          background: transparent;
        }

        header{
          padding: 12px 18px;
          border-bottom: 1px solid var(--border);
          font-weight: 900;
          display:flex;
          align-items:center;
          justify-content:space-between;
          gap:12px;
          min-height: 56px;
          background: linear-gradient(180deg, rgba(17,24,39,0.70) 0%, rgba(17,24,39,0.52) 100%);
          backdrop-filter: blur(10px);
        }

        .header-title{
          display:flex;
          align-items:center;
          gap:10px;
          min-width:0;
          white-space:nowrap;
          overflow:hidden;
          text-overflow:ellipsis;
          letter-spacing: -0.2px;
        }

        .header-title::before{
          content:"ü¶ô";
          opacity: 0.95;
        }

        .reset-chat-btn{
          padding: 8px 12px;
          border-radius: 999px;
          border: 1px solid rgba(248,113,113,0.45);
          background: rgba(248,113,113,0.10);
          color: #fecaca;
          cursor: pointer;
          font-weight: 800;
          font-size: 13px;
          line-height: 1;
          white-space: nowrap;
          transition: transform .12s ease, background .12s ease, border-color .12s ease;
        }
        .reset-chat-btn:hover{
          background: rgba(248,113,113,0.14);
          border-color: rgba(248,113,113,0.70);
          transform: translateY(-1px);
        }
        .reset-chat-btn:active{ transform: translateY(0px); }
        .reset-chat-btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

        .chat-wrapper{
          flex:1;
          min-height:0;
          overflow-y:auto;
          padding: 22px;
        }

        .chat{
          max-width: 920px;
          margin: 0 auto;
        }

        .msg{
          max-width: 75%;
          padding: 12px 16px;
          border-radius: 16px;
          margin-bottom: 14px;
          line-height: 1.65;
          white-space: pre-wrap;
          word-break: break-word;

          background: var(--surface);
          border: 1px solid var(--border);
          box-shadow: 0 10px 26px rgba(0,0,0,0.22);
        }

        .msg.user{
          margin-left:auto;
          background: linear-gradient(180deg, rgba(59,130,246,0.92), rgba(59,130,246,0.78));
          border-color: rgba(59,130,246,0.28);
          color:#fff;
        }

        .msg.assistant{
          margin-right:auto;
          background: linear-gradient(180deg, var(--assistant-strong), var(--assistant));
          border-color: var(--border);
          color: var(--text);
        }

        .msg.typing{
          margin-right:auto;
          background: linear-gradient(180deg, var(--assistant-strong), var(--assistant));
          color: var(--muted);
          font-style: italic;
        }

        .msg.typing::after{
          content:"...";
          animation: dots 1.2s infinite;
        }

        @keyframes dots{
          0% { content: "."; }
          33% { content: ".."; }
          66% { content: "..."; }
        }

        .input-bar{
          border-top: 1px solid var(--border);
          padding: 14px 18px;
          background: linear-gradient(180deg, rgba(17,24,39,0.56) 0%, rgba(17,24,39,0.70) 100%);
          backdrop-filter: blur(10px);
        }

        .input-inner{
          max-width: 920px;
          margin: 0 auto;
          display:flex;
          gap: 10px;
          align-items: stretch;
        }

        textarea#prompt{
          flex:1;
          resize:none;
          padding: 12px 12px;
          border-radius: 14px;
          background: rgba(15,23,42,0.55);
          border: 1px solid var(--border);
          color: var(--text);
          outline: none;
          box-shadow: 0 10px 26px rgba(0,0,0,0.18);
        }
        textarea#prompt::placeholder{ color: rgba(148,163,184,0.85); }
        textarea#prompt:focus{
          border-color: rgba(59,130,246,0.55);
          box-shadow:
            0 14px 34px rgba(59,130,246,0.16),
            0 0 0 4px rgba(59,130,246,0.12);
          background: rgba(15,23,42,0.68);
        }

        button{
          padding: 0 20px;
          border-radius: 14px;
          border: 1px solid rgba(59,130,246,0.30);
          background: linear-gradient(180deg, rgba(59,130,246,0.95), rgba(59,130,246,0.78));
          color: #fff;
          cursor: pointer;
          font-weight: 900;
          box-shadow: 0 12px 28px rgba(59,130,246,0.18);
          transition: transform .12s ease, filter .12s ease;
        }
        button:hover{ filter: brightness(1.03); transform: translateY(-1px); }
        button:active{ transform: translateY(0px); }
        button:disabled{
          opacity: 0.55;
          cursor: not-allowed;
          box-shadow: none;
          transform: none;
        }

        /* ===== RIGHT SETTINGS ===== */
        .settings{
          background: linear-gradient(180deg, rgba(17,24,39,0.78) 0%, rgba(17,24,39,0.70) 100%);
          border-left: 1px solid var(--border);
          padding: 18px 18px 22px;
          overflow-y: auto;
          backdrop-filter: blur(10px);
        }

        .settings h3{
          margin-top: 0;
          margin-bottom: 10px;
          font-weight: 950;
          letter-spacing: -0.3px;
        }

        /* ===== Shared UI blocks ===== */
        .card-block{
          background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.04));
          border: 1px solid var(--border);
          border-radius: 16px;
          padding: 14px 14px 12px;
          box-shadow: 0 12px 28px rgba(0,0,0,0.18);
          margin-bottom: 14px;
        }

        .section-title{
          display:flex;
          align-items:center;
          justify-content:space-between;
          gap:10px;
          margin-bottom: 10px;
        }

        .section-title .t{
          font-weight: 950;
          letter-spacing: -0.2px;
          display:flex;
          align-items:center;
          gap:8px;
        }

        .pill-mini{
          font-size: 11px;
          font-weight: 950;
          padding: 4px 8px;
          border-radius: 999px;
          border: 1px solid rgba(148,163,184,0.25);
          background: rgba(148,163,184,0.10);
          color: rgba(229,231,235,0.92);
          white-space: nowrap;
        }

        .hint{
          font-size: 12px;
          color: var(--muted);
          font-weight: 750;
          line-height: 1.35;
          margin-top: -4px;
          margin-bottom: 10px;
        }

        .field{
          margin-bottom: 12px;
        }

        .field label{
          font-size: 12px;
          color: var(--muted);
          display:block;
          margin-bottom: 6px;
          font-weight: 850;
          letter-spacing: -0.1px;
        }

        .field input[type="text"],
        .field input[type="number"],
        .field select,
        .field textarea{
          width: 100%;
          background: rgba(15,23,42,0.55);
          border: 1px solid var(--border);
          color: var(--text);
          border-radius: 12px;
          padding: 8px 10px;
          outline:none;
        }

        .field textarea{
          resize: vertical;
          min-height: 62px;
        }

        .field input[type="text"]:focus,
        .field input[type="number"]:focus,
        .field select:focus,
        .field textarea:focus{
          border-color: rgba(59,130,246,0.55);
          box-shadow: 0 0 0 4px rgba(59,130,246,0.12);
          background: rgba(15,23,42,0.68);
        }

        .grid-2{
          display:grid;
          grid-template-columns: 1fr 1fr;
          gap: 10px;
        }

        .grid-3{
          display:grid;
          grid-template-columns: 1fr 1fr 1fr;
          gap: 10px;
        }

        .inline-row{
          display:flex;
          align-items:center;
          justify-content:space-between;
          gap: 10px;
          margin-top: 10px;
        }

        .btn-ghost{
          width: 100% !important;
          padding: 12px 10px !important;
          border-radius: 14px !important;
          border: 1px solid var(--border) !important;
          background: linear-gradient(180deg, rgba(148,163,184,0.10), rgba(148,163,184,0.06)) !important;
          color: var(--text) !important;
          cursor: pointer !important;
          margin-top: 12px !important;
          font-weight: 900 !important;
          box-shadow: 0 12px 26px rgba(0,0,0,0.18) !important;
        }
        .btn-ghost:hover{ filter: brightness(1.03); transform: translateY(-1px); }

        .btn-brand{
          width: 100%;
          padding: 12px 10px;
          border-radius: 14px;
          border: 1px solid rgba(255,107,0,0.28);
          background: linear-gradient(180deg, rgba(255,107,0,0.96), rgba(255,107,0,0.78));
          color: #fff;
          cursor: pointer;
          margin-top: 12px;
          font-weight: 950;
          box-shadow: 0 14px 30px rgba(255,107,0,0.18);
          transition: transform .12s ease, filter .12s ease;
        }
        .btn-brand:hover{ filter: brightness(1.03); transform: translateY(-1px); }
        .btn-brand:active{ transform: translateY(0px); }

        .divider{
          height: 1px;
          background: rgba(148,163,184,0.16);
          margin: 12px 0;
        }

        .mono{
          font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
          font-size: 12px;
        }

        /* ===== Status panel (Í∏∞Ï°¥ ÌòÑÌô©Ìåê) ===== */
        .status-top{
          display:flex;
          align-items:center;
          justify-content:space-between;
          gap:10px;
          margin-bottom: 10px;
        }
        .status-title{
          font-weight: 950;
          letter-spacing: -0.2px;
          display:flex;
          align-items:center;
          gap:8px;
        }
        .status-badge{
          font-size: 12px;
          font-weight: 900;
          padding: 6px 10px;
          border-radius: 999px;
          border: 1px solid rgba(255,107,0,0.30);
          background: rgba(255,107,0,0.10);
          color: #ffd7bf;
          white-space: nowrap;
        }
        .status-row{
          display:flex;
          gap:10px;
          align-items:flex-start;
          margin-top: 8px;
        }
        .status-label{
          width: 110px;
          flex: 0 0 110px;
          color: var(--muted);
          font-weight: 800;
          font-size: 12px;
          padding-top: 2px;
        }
        .status-value{
          flex: 1;
          min-width: 0;
          font-size: 13px;
          font-weight: 800;
          color: var(--text);
        }
        .status-ellipsis{
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
          display:block;
          max-width: 100%;
        }
        .status-grid{
          display:grid;
          grid-template-columns: 1fr 1fr;
          gap: 10px;
          margin-top: 10px;
        }
        .kv{
          background: rgba(15,23,42,0.40);
          border: 1px solid var(--border);
          border-radius: 14px;
          padding: 10px 10px;
        }
        .kv .k{
          font-size: 12px;
          font-weight: 900;
          color: var(--muted);
          margin-bottom: 2px;
        }
        .kv .v{
          font-size: 14px;
          font-weight: 950;
          color: var(--text);
          letter-spacing: -0.1px;
        }

        /* ===== Fine-tuning Preset UI (Í∏∞Ï°¥ Ïú†ÏßÄ) ===== */
        .finetune-wrap{ margin-top: 14px; margin-bottom: 16px; }
        .finetune-head{ display:block; margin-bottom: 12px; }
        .finetune-head-left{ display:flex; flex-direction:column; gap:6px; }
        .finetune-head-title{
          font-size: 20px;
          font-weight: 950;
          letter-spacing: -0.3px;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }
        .finetune-head-desc{
          font-size: 12px;
          color: var(--muted);
          font-weight: 750;
          line-height: 1.35;
          word-break: keep-all;
          overflow: hidden;
          display: -webkit-box;
          -webkit-box-orient: vertical;
          -webkit-line-clamp: 2;
        }

        .finetune-grid{ display:grid; grid-template-columns: 1fr; gap: 10px; }
        .finetune-card{
          position: relative;
          background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.04));
          border: 1px solid var(--border);
          border-radius: 16px;
          padding: 12px 12px 10px;
          cursor: pointer;
          box-shadow: 0 12px 28px rgba(0,0,0,0.16);
          transition: transform .12s ease, border-color .12s ease, filter .12s ease;
          user-select: none;
        }
        .finetune-card:hover{ transform: translateY(-1px); filter: brightness(1.02); }
        .finetune-card.selected{
          border-color: rgba(255,107,0,0.55);
          box-shadow:
            0 14px 34px rgba(255,107,0,0.10),
            0 0 0 4px rgba(255,107,0,0.12);
        }
        .finetune-top{
          display:flex;
          align-items:center;
          justify-content:space-between;
          gap:10px;
          margin-bottom: 6px;
        }
        .finetune-title{
          font-weight: 950;
          letter-spacing: -0.2px;
          display:flex;
          align-items:center;
          gap:8px;
          min-width: 0;
        }
        .finetune-title span:first-child{
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
          max-width: 220px;
        }
        .finetune-title .pill{
          font-size: 11px;
          font-weight: 950;
          padding: 4px 8px;
          border-radius: 999px;
          border: 1px solid rgba(59,130,246,0.25);
          background: rgba(59,130,246,0.10);
          color: #cfe3ff;
          white-space: nowrap;
        }
        .finetune-title .pill.rec{
          border: 1px solid rgba(255,107,0,0.30);
          background: rgba(255,107,0,0.10);
          color: #ffd7bf;
        }
        .finetune-short{
          font-size: 13px;
          color: var(--text);
          font-weight: 800;
          line-height: 1.45;
        }
        .finetune-actions{
          margin-top: 8px;
          display:flex;
          align-items:center;
          justify-content:space-between;
          gap:10px;
        }
        .finetune-more{
          font-size: 12px;
          color: var(--muted);
          font-weight: 850;
          text-decoration: underline;
          cursor: pointer;
          user-select:none;
          background: transparent;
          border: none;
          padding: 0;
        }
        .finetune-radio{
          appearance: none;
          width: 16px;
          height: 16px;
          border-radius: 999px;
          border: 2px solid rgba(148,163,184,0.65);
          display:inline-block;
          position: relative;
          flex: 0 0 auto;
        }
        .finetune-card.selected .finetune-radio{ border-color: rgba(255,107,0,0.85); }
        .finetune-card.selected .finetune-radio::after{
          content:"";
          position:absolute;
          inset: 3px;
          border-radius: 999px;
          background: rgba(255,107,0,0.95);
        }

        .finetune-detail{
          margin-top: 10px;
          padding-top: 10px;
          border-top: 1px dashed rgba(148,163,184,0.22);

          display: grid;
          gap: 8px;

          font-size: 12.5px;
          line-height: 1.45;
          font-weight: 750;
          color: rgba(229,231,235,0.92);
        }
        .ft-row{
          display: grid;
          grid-template-columns: 92px 1fr;
          gap: 10px;
          align-items: start;
        }
        .ft-k{
          color: var(--muted);
          font-weight: 900;
          font-size: 12px;
          letter-spacing: -0.1px;
        }
        .ft-v{
          color: rgba(229,231,235,0.95);
          word-break: break-word;
        }
        .ft-code{
          font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
          font-size: 12px;
          padding: 2px 6px;
          border-radius: 8px;
          border: 1px solid rgba(148,163,184,0.22);
          background: rgba(15,23,42,0.35);
          color: rgba(229,231,235,0.95);
          white-space: nowrap;
        }

        /* ===== overlay ===== */
        .overlay{
          position: fixed;
          inset: 0;
          background: rgba(0,0,0,0.45);
          backdrop-filter: blur(2px);
          display: none;
          align-items: center;
          justify-content: center;
          z-index: 9999;
          pointer-events: all;
        }
        .overlay-box{
          background: rgba(17,24,39,0.92);
          border: 1px solid var(--border-2);
          color: var(--text);
          padding: 20px 26px;
          border-radius: 16px;
          font-size: 15px;
          font-weight: 900;
          box-shadow: var(--shadow);
          backdrop-filter: blur(10px);
        }

        /* ===== Logs box ===== */
        .logbox{
          background: rgba(15,23,42,0.40);
          border: 1px solid var(--border);
          border-radius: 14px;
          padding: 10px 10px;
          height: 140px;
          overflow: auto;
          font-size: 12px;
          line-height: 1.55;
          white-space: pre-wrap;
          word-break: break-word;
          color: rgba(229,231,235,0.92);
        }

        /* ===== NAVBAR (Í≥µÏö©) - ÏàòÏ†ï Í∏àÏßÄ ===== */
        .predict-navbar {
          background: linear-gradient(90deg, #0b1d33, #0f2a52);
          height: var(--nav-h);
          padding: 0 2rem !important;
          border-bottom: none;
        }
        .predict-navbar .nav-link {
          color: #fff !important;
          font-weight: 500;
          font-size: 1rem;
          transition: color 0.25s ease, transform 0.25s ease;
          display: inline-block;
        }
        .predict-navbar .nav-link:hover {
          color: #ff6b00 !important;
          transform: translateY(-2px);
        }
        .predict-navbar .navbar-brand img {
          height: 40px;
          filter: brightness(1.1);
        }
        .predict-navbar .navbar-toggler {
          border-color: rgba(255,255,255,0.5);
        }
        .predict-navbar .navbar-toggler-icon {
          filter: brightness(200%);
        }

        .chat-wrapper::-webkit-scrollbar,
        .settings::-webkit-scrollbar { width: 10px; }

        .chat-wrapper::-webkit-scrollbar-thumb,
        .settings::-webkit-scrollbar-thumb{
          background: rgba(148,163,184,0.28);
          border-radius: 999px;
          border: 2px solid rgba(17,24,39,0.55);
        }

        .chat-wrapper::-webkit-scrollbar-track,
        .settings::-webkit-scrollbar-track{ background: rgba(0,0,0,0); }

        @media (max-width: 992px){
          .app{ grid-template-columns: 1fr; }
          .settings{ display:none; }
        }
    </style>

    <script>
        /**************************************************************
         * 1) ÏÑúÎ≤Ñ Ï†úÍ≥µ ÎîîÌè¥Ìä∏Îì§
         **************************************************************/
        const DEFAULT_PRESET = {{ (default_params if default_params is defined else (params if params is defined else {})) | tojson }};
        const DEFAULT_SYSTEM_PROMPT = {{ (default_system_prompt if default_system_prompt is defined else (system_prompt if system_prompt is defined else "")) | tojson }};

        // Fine-tuning presets (Ï≤¥ÌÅ¨Ìè¨Ïù∏Ìä∏ ÏÑ†ÌÉùÏùÄ ÌîÑÎ¶¨ÏÖã Ïú†ÏßÄ)
        const SERVER_FINETUNE_PRESETS = {{ (finetune_presets if finetune_presets is defined else []) | tojson }};
        const DEFAULT_FINETUNE_ID = {{ (default_finetune_id if default_finetune_id is defined else "") | tojson }};

        // ÌååÏù∏ÌäúÎãù Í∏∞Î≥∏ ÏÑ§Ï†ï(ÏÑúÎ≤ÑÏóêÏÑú Ï£ºÎ©¥ Ïö∞ÏÑ† ÏÇ¨Ïö©)
        // server expected:
        // default_train_cfg: { data:{...}, lora:{...}, train:{...}, quant:{...}, prompt:{...}, output:{...} }
        const SERVER_DEFAULT_TRAIN_CFG = {{ (default_train_cfg if default_train_cfg is defined else {}) | tojson }};

        /**************************************************************
         * 2) fallback finetune preset
         **************************************************************/
        const FALLBACK_FINETUNE_PRESETS = [
          {
            id: "ckpt_50",
            title: "Checkpoint 50",
            badge: "step 50/100",
            recommended: false,
            short: "ÎèôÏùº Instruction SFT(run) Ï§ëÍ∞Ñ Ï†ÄÏû•Î≥∏ (global_step=50)",
            detail_kv: [
              { k: "Snapshot",  v: "global_step=50 (max_steps=100, save_steps=50)" },
              { k: "Training",  v: "Instruction SFT (Alpaca template)" },
              { k: "Base",      v: "Meta-Llama-3-8B (4-bit NF4)" },
              { k: "PEFT",      v: "LoRA (PEFT) adapter-only (r=16, alpha=16)" },
              { k: "Objective", v: 'completion-only loss on Response span (after "### Response")' },
            ],
          },
          {
            id: "ckpt_100",
            title: "Checkpoint 100",
            badge: "step 100/100",
            recommended: true,
            short: "ÎèôÏùº Instruction SFT(run) ÏµúÏ¢Ö Ï†ÄÏû•Î≥∏ (global_step=100, training end)",
            detail_kv: [
              { k: "Snapshot",  v: "global_step=100 (training end)" },
              { k: "Diff",      v: "ckpt_50Í≥º ÌïôÏäµ ÏÑ§Ï†ï ÎèôÏùº, Ï†ÄÏû• stepÎßå Îã§Î¶Ñ (50 vs 100)" },
              { k: "Training",  v: "Instruction SFT (Alpaca template)" },
              { k: "Base",      v: "Meta-Llama-3-8B (4-bit NF4)" },
              { k: "PEFT",      v: "LoRA (PEFT) adapter-only (r=16, alpha=16)" },
              { k: "Objective", v: 'completion-only loss on Response span (after "### Response")' },
            ],
          }
        ];

        const FINETUNE_PRESETS = (Array.isArray(SERVER_FINETUNE_PRESETS) && SERVER_FINETUNE_PRESETS.length)
          ? SERVER_FINETUNE_PRESETS
          : FALLBACK_FINETUNE_PRESETS;

        /**************************************************************
         * 3) ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ï†ÅÏö©Ï§ë Í∞í (Ï±ÑÌåÖÏö©)
         **************************************************************/
        let appliedSystemPrompt = DEFAULT_SYSTEM_PROMPT;
        let appliedParams = { ...DEFAULT_PRESET };
        let appliedFinetuneId = DEFAULT_FINETUNE_ID || (FINETUNE_PRESETS[0] ? FINETUNE_PRESETS[0].id : "");

        /**************************************************************
         * 4) ÌååÏù∏ÌäúÎãù ÏÑ§Ï†ï(ÌïôÏäµ Ïã§ÌñâÏö©) - UIÏóêÏÑú Ìé∏Ïßë Í∞ÄÎä•
         *    - ÏÑúÎ≤ÑÏóêÏÑú default_train_cfg Ï£ºÎ©¥ merge
         **************************************************************/
        const FALLBACK_TRAIN_CFG = {
          data: {
            dataset_path: "/workspace/data/train.jsonl",
            eval_path: "",
            text_field: "text",
            split_ratio: 0.0,                 // 0Ïù¥Î©¥ eval ÎØ∏ÏÇ¨Ïö©
            max_seq_length: 2048,
            packing: false
          },
          prompt: {
            template: "alpaca",               // alpaca | chatml | custom
            instruction_key: "instruction",
            response_key: "response",
            custom_format: ""                 // template=customÏùº Îïå ÏÇ¨Ïö©
          },
          lora: {
            r: 16,
            alpha: 16,
            dropout: 0.05,
            target_modules: "q_proj,k_proj,v_proj,o_proj", // CSV
            bias: "none"                      // none|all|lora_only
          },
          quant: {
            load_in_4bit: true,
            bnb_4bit_quant_type: "nf4",       // nf4|fp4
            bnb_4bit_compute_dtype: "bfloat16", // float16|bfloat16|float32
            bnb_4bit_use_double_quant: true
          },
          train: {
            base_model: "meta-llama/Meta-Llama-3-8B",
            learning_rate: 2e-4,
            per_device_train_batch_size: 1,
            gradient_accumulation_steps: 8,
            max_steps: 100,
            warmup_ratio: 0.03,
            weight_decay: 0.0,
            lr_scheduler_type: "cosine",      // linear|cosine|constant|constant_with_warmup
            optim: "paged_adamw_8bit",        // adamw_torch|paged_adamw_8bit|paged_adamw_32bit
            bf16: true,
            fp16: false,
            seed: 42,
            logging_steps: 10,
            save_steps: 50,
            eval_steps: 0
          },
          output: {
            output_dir: "/workspace/fine_tune_output",
            run_name: "llama3_lora_sft",
            save_total_limit: 2,
            push_to_hub: false,
            hub_repo_id: ""
          }
        };

        function deepMerge(dst, src){
          if (!src || typeof src !== "object") return dst;
          for (const k of Object.keys(src)){
            const sv = src[k];
            if (sv && typeof sv === "object" && !Array.isArray(sv)){
              if (!dst[k] || typeof dst[k] !== "object") dst[k] = {};
              deepMerge(dst[k], sv);
            } else {
              dst[k] = sv;
            }
          }
          return dst;
        }

        let trainCfg = deepMerge(structuredClone(FALLBACK_TRAIN_CFG), SERVER_DEFAULT_TRAIN_CFG || {});

        /**************************************************************
         * 5) ÌïòÏù¥ÌçºÌååÎùºÎØ∏ÌÑ∞(Ï±ÑÌåÖ) Ïä§Ìéô
         **************************************************************/
        const PARAM_SPECS = {
          temperature: {type: "float", min: 0.0, max: 2.0},
          top_p: {type: "float", min: 0.0, max: 1.0},
          top_k: {type: "int", min: 0, max: 200},
          max_tokens: {type: "int", min: 1, max: 4096},
          repetition_penalty: {type: "float", min: 0.5, max: 2.5},
        };

        /**************************************************************
         * 6) Ïø†ÌÇ§ ÌûàÏä§ÌÜ†Î¶¨ (Í∏∞Ï°¥ Ïú†ÏßÄ)
         **************************************************************/
        const CHAT_COOKIE_NAME = "llama_chat_history";
        const CHAT_MAX_TURNS = 12;
        const CHAT_MAX_CHARS = 6000;

        function setCookie(name, value, maxAgeSeconds = 60 * 60 * 24 * 7) {
          document.cookie = `${name}=${value}; Path=/; Max-Age=${maxAgeSeconds}; SameSite=Lax`;
        }
        function getCookie(name) {
          const parts = document.cookie.split(";").map(v => v.trim());
          for (const p of parts) {
            if (p.startsWith(name + "=")) return p.slice(name.length + 1);
          }
          return "";
        }
        function deleteCookie(name) {
          document.cookie = `${name}=; Path=/; Max-Age=0; SameSite=Lax`;
        }
        function b64EncodeUnicode(str) { return btoa(unescape(encodeURIComponent(str))); }
        function b64DecodeUnicode(str) { return decodeURIComponent(escape(atob(str))); }

        function loadChatHistoryFromCookie() {
          try {
            const raw = getCookie(CHAT_COOKIE_NAME);
            if (!raw) return [];
            const json = b64DecodeUnicode(raw);
            const arr = JSON.parse(json);
            if (!Array.isArray(arr)) return [];
            return arr
              .filter(m => m && (m.role === "user" || m.role === "assistant") && typeof m.content === "string")
              .map(m => ({ role: m.role, content: m.content }));
          } catch (e) {
            return [];
          }
        }

        function saveChatHistoryToCookie(history) {
          try {
            let arr = Array.isArray(history) ? history.slice() : [];
            if (arr.length > CHAT_MAX_TURNS) arr = arr.slice(arr.length - CHAT_MAX_TURNS);

            let total = 0;
            arr = arr.filter(m => {
              total += (m.content || "").length;
              return total <= CHAT_MAX_CHARS;
            });

            const json = JSON.stringify(arr);
            const raw = b64EncodeUnicode(json);
            setCookie(CHAT_COOKIE_NAME, raw);
            return arr;
          } catch (e) {
            return Array.isArray(history) ? history : [];
          }
        }

        let chatHistory = loadChatHistoryFromCookie();
        function pushHistory(role, content) {
          chatHistory.push({ role, content: String(content ?? "") });
          chatHistory = saveChatHistoryToCookie(chatHistory);
        }

        /**************************************************************
         * 7) Ïú†Ìã∏
         **************************************************************/
        function clamp(v, mn, mx){ return v > mx ? mx : (v < mn ? mn : v); }

        function coerceInput(key, raw){
          const spec = PARAM_SPECS[key];
          try{
            let v;
            if(spec.type === "int") v = parseInt(String(raw), 10);
            else v = parseFloat(String(raw));
            if(Number.isNaN(v)) throw new Error("NaN");
            v = clamp(v, spec.min, spec.max);
            if(spec.type === "int") v = Math.trunc(v);
            return v;
          }catch(e){
            return DEFAULT_PRESET[key];
          }
        }

        function scrollToBottom(wrapper) {
          requestAnimationFrame(() => { wrapper.scrollTop = wrapper.scrollHeight; });
        }

        function bindRangeNumber(rangeEl, numberEl) {
          if (!rangeEl || !numberEl) return;

          const min = Number(rangeEl.min);
          const max = Number(rangeEl.max);
          const step = Number(rangeEl.step || 1);

          const clampToStep = (val) => {
            if (Number.isNaN(val)) return Number(rangeEl.value);
            let v = Math.min(max, Math.max(min, val));
            const decimals = (String(step).split(".")[1] || "").length;
            const snapped = Math.round((v - min) / step) * step + min;
            return Number(snapped.toFixed(decimals));
          };

          const syncFromRange = () => { numberEl.value = rangeEl.value; };
          const syncFromNumber = () => {
            const v = clampToStep(Number(numberEl.value));
            rangeEl.value = String(v);
            numberEl.value = String(v);
          };

          rangeEl.addEventListener("input", syncFromRange);
          numberEl.addEventListener("input", () => {
            const raw = Number(numberEl.value);
            if (Number.isNaN(raw)) return;
            rangeEl.value = Math.min(max, Math.max(min, raw));
          });
          numberEl.addEventListener("change", syncFromNumber);
          numberEl.addEventListener("blur", syncFromNumber);

          syncFromRange();
        }

        function setOverlay(show, text) {
          const overlay = document.getElementById("overlay");
          const box = document.getElementById("overlayText");
          if (text) box.textContent = text;
          overlay.style.display = show ? "flex" : "none";

          if (show) {
            document.body.dataset.prevOverflow = document.body.style.overflow || "";
            document.body.style.overflow = "hidden";
          } else {
            document.body.style.overflow = document.body.dataset.prevOverflow || "";
            delete document.body.dataset.prevOverflow;
          }
        }

        function setParam(id, value) {
          const range = document.getElementById(id);
          const num = document.getElementById(id + "_num");
          if (!range || !num) return;
          range.value = value;
          num.value = value;
          range.dispatchEvent(new Event("input"));
        }

        function promptPreview(text, n=140){
          const t = (text || "").replace(/\s+/g, " ").trim();
          if(!t) return "(ÎπÑÏñ¥ÏûàÏùå)";
          return t.length > n ? (t.slice(0, n) + "‚Ä¶") : t;
        }

        function finetuneLabelById(id){
          const x = FINETUNE_PRESETS.find(p => p.id === id);
          if(!x) return id || "(ÎØ∏ÏÑ†ÌÉù)";
          const badge = x.badge ? ` ¬∑ ${x.badge}` : "";
          return `${x.title}${badge}`;
        }

        function setSelectedFinetune(id){
          const hidden = document.getElementById("finetuneInput");
          if(hidden) hidden.value = id;

          const cards = document.querySelectorAll(".finetune-card");
          cards.forEach(c => c.classList.toggle("selected", c.dataset.id === id));
        }

        function formatDetailValue(v){
          const s = String(v ?? "");
          return s
            .replace(/\b(global_step=\d+)\b/g, "<span class='ft-code'>$1</span>")
            .replace(/\b(max_steps=\d+)\b/g, "<span class='ft-code'>$1</span>")
            .replace(/\b(save_steps=\d+)\b/g, "<span class='ft-code'>$1</span>")
            .replace(/\b(4-bit NF4)\b/g, "<span class='ft-code'>$1</span>")
            .replace(/\b(LoRA)\b/g, "<span class='ft-code'>$1</span>");
        }

        function renderFinetuneCards(selectedId){
          const grid = document.getElementById("finetuneGrid");
          if(!grid) return;

          grid.innerHTML = "";

          FINETUNE_PRESETS.forEach((p, idx) => {
            const card = document.createElement("div");
            card.className = "finetune-card" + (p.id === selectedId ? " selected" : "");
            card.dataset.id = p.id;

            const pillClass = p.recommended ? "pill rec" : "pill";
            const pillText = p.badge || (p.recommended ? "Ï∂îÏ≤ú" : "ÌîÑÎ¶¨ÏÖã");
            const detailId = `ft_detail_${idx}`;

            card.innerHTML = `
              <div class="finetune-top">
                <div class="finetune-title">
                  <span title="${(p.title || "").replace(/"/g, "&quot;")}">${p.title || ""}</span>
                  <span class="${pillClass}">${pillText}</span>
                </div>
                <span class="finetune-radio" aria-hidden="true"></span>
              </div>

              <div class="finetune-short">${p.short || ""}</div>

              <div class="finetune-actions">
                <button type="button" class="finetune-more" data-bs-toggle="collapse" data-bs-target="#${detailId}">
                  ÏÉÅÏÑ∏ Î≥¥Í∏∞
                </button>
                <span style="font-size:12px; color: var(--muted); font-weight:800;">ID: ${p.id}</span>
              </div>

              <div id="${detailId}" class="collapse">
                <div class="finetune-detail">
                  ${Array.isArray(p.detail_kv) ? p.detail_kv.map(row => `
                    <div class="ft-row">
                      <div class="ft-k">${row.k}</div>
                      <div class="ft-v">${formatDetailValue(row.v)}</div>
                    </div>
                  `).join("") : ""}
                </div>
              </div>
            `;

            card.addEventListener("click", () => setSelectedFinetune(p.id));
            grid.appendChild(card);
          });
        }

        function renderAppliedPanel(){
          const badge = document.getElementById("appliedBadge");
          if (badge) badge.textContent = "Ï†ÅÏö©Îê®";

          const sp = document.getElementById("appliedPrompt");
          if (sp) sp.textContent = promptPreview(appliedSystemPrompt, 160);

          const ft = document.getElementById("appliedFinetune");
          if (ft) ft.textContent = finetuneLabelById(appliedFinetuneId);

          const setKV = (id, v) => {
            const el = document.getElementById(id);
            if (el) el.textContent = String(v);
          };
          setKV("applied_temperature", appliedParams.temperature);
          setKV("applied_top_p", appliedParams.top_p);
          setKV("applied_top_k", appliedParams.top_k);
          setKV("applied_max_tokens", appliedParams.max_tokens);
          setKV("applied_repetition_penalty", appliedParams.repetition_penalty);
        }

        function readInputsToChatConfig(){
          const spInput = document.getElementById("systemPromptInput");
          const spRaw = spInput ? spInput.value : "";
          const sp = (spRaw || "").trim() || DEFAULT_SYSTEM_PROMPT;

          const ftHidden = document.getElementById("finetuneInput");
          const finetune_id = (ftHidden && ftHidden.value) ? ftHidden.value : appliedFinetuneId;

          const getNum = (id) => {
            const el = document.getElementById(id);
            return el ? el.value : "";
          };

          const params = {
            temperature: coerceInput("temperature", getNum("temperature_num")),
            top_p: coerceInput("top_p", getNum("top_p_num")),
            top_k: coerceInput("top_k", getNum("top_k_num")),
            max_tokens: coerceInput("max_tokens", getNum("max_tokens_num")),
            repetition_penalty: coerceInput("repetition_penalty", getNum("repetition_penalty_num")),
          };

          return { system_prompt: sp, finetune_id, params };
        }

        /**************************************************************
         * 8) Fine-tune settings: UI ‚Üî trainCfg binding
         **************************************************************/
        function setValue(id, v){
          const el = document.getElementById(id);
          if (!el) return;
          if (el.type === "checkbox") el.checked = !!v;
          else el.value = (v === undefined || v === null) ? "" : String(v);
        }

        function getValue(id){
          const el = document.getElementById(id);
          if (!el) return null;
          if (el.type === "checkbox") return !!el.checked;
          return el.value;
        }

        function renderTrainCfgToUI(){
          // data
          setValue("ft_dataset_path", trainCfg.data.dataset_path);
          setValue("ft_eval_path", trainCfg.data.eval_path);
          setValue("ft_text_field", trainCfg.data.text_field);
          setValue("ft_split_ratio", trainCfg.data.split_ratio);
          setValue("ft_max_seq_length", trainCfg.data.max_seq_length);
          setValue("ft_packing", trainCfg.data.packing);

          // prompt
          setValue("ft_template", trainCfg.prompt.template);
          setValue("ft_instruction_key", trainCfg.prompt.instruction_key);
          setValue("ft_response_key", trainCfg.prompt.response_key);
          setValue("ft_custom_format", trainCfg.prompt.custom_format);

          // lora
          setValue("ft_lora_r", trainCfg.lora.r);
          setValue("ft_lora_alpha", trainCfg.lora.alpha);
          setValue("ft_lora_dropout", trainCfg.lora.dropout);
          setValue("ft_lora_targets", trainCfg.lora.target_modules);
          setValue("ft_lora_bias", trainCfg.lora.bias);

          // quant
          setValue("ft_4bit", trainCfg.quant.load_in_4bit);
          setValue("ft_quant_type", trainCfg.quant.bnb_4bit_quant_type);
          setValue("ft_compute_dtype", trainCfg.quant.bnb_4bit_compute_dtype);
          setValue("ft_double_quant", trainCfg.quant.bnb_4bit_use_double_quant);

          // train
          setValue("ft_base_model", trainCfg.train.base_model);
          setValue("ft_lr", trainCfg.train.learning_rate);
          setValue("ft_bsz", trainCfg.train.per_device_train_batch_size);
          setValue("ft_gas", trainCfg.train.gradient_accumulation_steps);
          setValue("ft_max_steps", trainCfg.train.max_steps);
          setValue("ft_warmup_ratio", trainCfg.train.warmup_ratio);
          setValue("ft_weight_decay", trainCfg.train.weight_decay);
          setValue("ft_sched", trainCfg.train.lr_scheduler_type);
          setValue("ft_optim", trainCfg.train.optim);
          setValue("ft_bf16", trainCfg.train.bf16);
          setValue("ft_fp16", trainCfg.train.fp16);
          setValue("ft_seed", trainCfg.train.seed);
          setValue("ft_logging_steps", trainCfg.train.logging_steps);
          setValue("ft_save_steps", trainCfg.train.save_steps);
          setValue("ft_eval_steps", trainCfg.train.eval_steps);

          // output
          setValue("ft_output_dir", trainCfg.output.output_dir);
          setValue("ft_run_name", trainCfg.output.run_name);
          setValue("ft_save_total_limit", trainCfg.output.save_total_limit);
          setValue("ft_push_to_hub", trainCfg.output.push_to_hub);
          setValue("ft_hub_repo_id", trainCfg.output.hub_repo_id);

          // template UI toggle
          updateCustomTemplateVisibility();
          updateEvalVisibility();
        }

        function updateCustomTemplateVisibility(){
          const t = getValue("ft_template");
          const wrap = document.getElementById("ft_custom_wrap");
          if (!wrap) return;
          wrap.style.display = (t === "custom") ? "block" : "none";
        }

        function updateEvalVisibility(){
          const ratio = parseFloat(getValue("ft_split_ratio") || "0");
          const evalPath = document.getElementById("ft_eval_path");
          const evalSteps = document.getElementById("ft_eval_steps");
          const hint = document.getElementById("ft_eval_hint");
          const enable = (ratio > 0) || ((evalPath && evalPath.value || "").trim().length > 0);

          if (evalSteps) evalSteps.disabled = !enable;
          if (hint) hint.textContent = enable
            ? "EvalÏù¥ ÌôúÏÑ±ÌôîÎê©ÎãàÎã§ (split_ratio>0 ÎòêÎäî eval_path Ï°¥Ïû¨)."
            : "Eval ÎπÑÌôúÏÑ±Ìôî ÏÉÅÌÉúÏûÖÎãàÎã§. split_ratioÎ•º 0Î≥¥Îã§ ÌÅ¨Í≤å ÌïòÍ±∞ÎÇò eval_pathÎ•º ÏßÄÏ†ïÌïòÏÑ∏Ïöî.";
        }

        function readUIToTrainCfg(){
          const cfg = structuredClone(trainCfg);

          // helpers
          const num = (id, def=0) => {
            const v = parseFloat(getValue(id) ?? "");
            return Number.isFinite(v) ? v : def;
          };
          const int = (id, def=0) => {
            const v = parseInt(getValue(id) ?? "", 10);
            return Number.isFinite(v) ? v : def;
          };
          const str = (id, def="") => {
            const v = String(getValue(id) ?? "").trim();
            return v.length ? v : def;
          };
          const bool = (id, def=false) => {
            const v = getValue(id);
            return (typeof v === "boolean") ? v : def;
          };

          // data
          cfg.data.dataset_path = str("ft_dataset_path", cfg.data.dataset_path);
          cfg.data.eval_path = str("ft_eval_path", "");
          cfg.data.text_field = str("ft_text_field", cfg.data.text_field);
          cfg.data.split_ratio = clamp(num("ft_split_ratio", 0), 0, 0.5);
          cfg.data.max_seq_length = clamp(int("ft_max_seq_length", cfg.data.max_seq_length), 256, 8192);
          cfg.data.packing = bool("ft_packing", false);

          // prompt
          cfg.prompt.template = str("ft_template", cfg.prompt.template);
          cfg.prompt.instruction_key = str("ft_instruction_key", cfg.prompt.instruction_key);
          cfg.prompt.response_key = str("ft_response_key", cfg.prompt.response_key);
          cfg.prompt.custom_format = String(getValue("ft_custom_format") ?? "");

          // lora
          cfg.lora.r = clamp(int("ft_lora_r", cfg.lora.r), 1, 256);
          cfg.lora.alpha = clamp(int("ft_lora_alpha", cfg.lora.alpha), 1, 512);
          cfg.lora.dropout = clamp(num("ft_lora_dropout", cfg.lora.dropout), 0.0, 0.5);
          cfg.lora.target_modules = str("ft_lora_targets", cfg.lora.target_modules);
          cfg.lora.bias = str("ft_lora_bias", cfg.lora.bias);

          // quant
          cfg.quant.load_in_4bit = bool("ft_4bit", cfg.quant.load_in_4bit);
          cfg.quant.bnb_4bit_quant_type = str("ft_quant_type", cfg.quant.bnb_4bit_quant_type);
          cfg.quant.bnb_4bit_compute_dtype = str("ft_compute_dtype", cfg.quant.bnb_4bit_compute_dtype);
          cfg.quant.bnb_4bit_use_double_quant = bool("ft_double_quant", cfg.quant.bnb_4bit_use_double_quant);

          // train
          cfg.train.base_model = str("ft_base_model", cfg.train.base_model);
          cfg.train.learning_rate = clamp(num("ft_lr", cfg.train.learning_rate), 1e-6, 5e-3);
          cfg.train.per_device_train_batch_size = clamp(int("ft_bsz", cfg.train.per_device_train_batch_size), 1, 64);
          cfg.train.gradient_accumulation_steps = clamp(int("ft_gas", cfg.train.gradient_accumulation_steps), 1, 256);
          cfg.train.max_steps = clamp(int("ft_max_steps", cfg.train.max_steps), 1, 100000);
          cfg.train.warmup_ratio = clamp(num("ft_warmup_ratio", cfg.train.warmup_ratio), 0.0, 0.3);
          cfg.train.weight_decay = clamp(num("ft_weight_decay", cfg.train.weight_decay), 0.0, 1.0);
          cfg.train.lr_scheduler_type = str("ft_sched", cfg.train.lr_scheduler_type);
          cfg.train.optim = str("ft_optim", cfg.train.optim);
          cfg.train.bf16 = bool("ft_bf16", cfg.train.bf16);
          cfg.train.fp16 = bool("ft_fp16", cfg.train.fp16);
          cfg.train.seed = clamp(int("ft_seed", cfg.train.seed), 0, 2147483647);
          cfg.train.logging_steps = clamp(int("ft_logging_steps", cfg.train.logging_steps), 1, 100000);
          cfg.train.save_steps = clamp(int("ft_save_steps", cfg.train.save_steps), 1, 100000);
          cfg.train.eval_steps = clamp(int("ft_eval_steps", cfg.train.eval_steps), 0, 100000);

          // output
          cfg.output.output_dir = str("ft_output_dir", cfg.output.output_dir);
          cfg.output.run_name = str("ft_run_name", cfg.output.run_name);
          cfg.output.save_total_limit = clamp(int("ft_save_total_limit", cfg.output.save_total_limit), 1, 50);
          cfg.output.push_to_hub = bool("ft_push_to_hub", cfg.output.push_to_hub);
          cfg.output.hub_repo_id = str("ft_hub_repo_id", "");

          return cfg;
        }

        function buildFinetunePayload(){
          const ftHidden = document.getElementById("finetuneInput");
          const finetune_id = (ftHidden && ftHidden.value) ? ftHidden.value : appliedFinetuneId;

          const cfg = readUIToTrainCfg();

          // ‚ÄúÏ≤¥ÌÅ¨Ìè¨Ïù∏Ìä∏ ÌîÑÎ¶¨ÏÖã‚ÄùÏùÄ ÌååÏù∏ÌäúÎãù ÏãúÏûëÏ†ê/Ïû¨Í∞úÎ°ú ÏÇ¨Ïö©ÌïúÎã§Îäî Ïª®ÏÖâ
          // (Î∞±ÏóîÎìúÏóêÏÑú finetune_id -> Ïã§Ï†ú Í≤ΩÎ°ú/Ïñ¥ÎåëÌÑ∞ Î°úÎìú Ï†ÑÎûµÏúºÎ°ú Îß§Ìïë)
          return {
            finetune_id,
            train_cfg: cfg
          };
        }

        function logAppend(line){
          const box = document.getElementById("ft_logs");
          if (!box) return;
          const t = String(line ?? "");
          box.textContent = (box.textContent + (box.textContent ? "\n" : "") + t).slice(-8000);
          box.scrollTop = box.scrollHeight;
        }

        function setFtStatus(text, pill){
          const el = document.getElementById("ft_status");
          if (el) el.textContent = text || "-";
          const p = document.getElementById("ft_status_pill");
          if (p && pill) p.textContent = pill;
        }

        /**************************************************************
         * 9) DOM Ready
         **************************************************************/
        document.addEventListener("DOMContentLoaded", () => {
          const textarea = document.getElementById("prompt");
          const sendBtn = document.getElementById("send");
          const resetChatBtn = document.getElementById("resetChat");
          const resetChatForm = document.getElementById("resetChatForm");

          const chat = document.querySelector(".chat");
          const wrapper = document.querySelector(".chat-wrapper");

          const systemPromptInput = document.getElementById("systemPromptInput");

          const temperature = document.getElementById("temperature");
          const temperature_num = document.getElementById("temperature_num");
          const top_p = document.getElementById("top_p");
          const top_p_num = document.getElementById("top_p_num");
          const top_k = document.getElementById("top_k");
          const top_k_num = document.getElementById("top_k_num");
          const max_tokens = document.getElementById("max_tokens");
          const max_tokens_num = document.getElementById("max_tokens_num");
          const repetition_penalty = document.getElementById("repetition_penalty");
          const repetition_penalty_num = document.getElementById("repetition_penalty_num");

          // Fine-tuning cards init
          renderFinetuneCards(appliedFinetuneId);
          setSelectedFinetune(appliedFinetuneId);

          // Ï¥àÍ∏∞ Ï†ÅÏö©Ï§ë (Ï±ÑÌåÖ)
          appliedSystemPrompt = DEFAULT_SYSTEM_PROMPT;
          appliedParams = { ...DEFAULT_PRESET };
          renderAppliedPanel();
          scrollToBottom(wrapper);

          // Fine-tune settings init
          renderTrainCfgToUI();
          setFtStatus("ÎåÄÍ∏∞", "Ready");
          logAppend("[UI] Fine-tune settings loaded.");

          // change handlers
          const templateSel = document.getElementById("ft_template");
          if (templateSel) templateSel.addEventListener("change", updateCustomTemplateVisibility);

          const splitRatio = document.getElementById("ft_split_ratio");
          if (splitRatio) splitRatio.addEventListener("input", updateEvalVisibility);

          const evalPath = document.getElementById("ft_eval_path");
          if (evalPath) evalPath.addEventListener("input", updateEvalVisibility);

          // Send enable/disable
          sendBtn.disabled = true;
          textarea.addEventListener("input", () => {
            sendBtn.disabled = textarea.value.trim() === "";
          });

          textarea.addEventListener("keydown", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
              e.preventDefault();
              if (!sendBtn.disabled) sendBtn.click();
            }
          });

          let isSending = false;
          let isResetting = false;
          let isFinetuning = false;

          // Send (Ï±ÑÌåÖ: Ï†ÅÏö©Ï§ë Í∞íÏúºÎ°ú /llama Ìò∏Ï∂ú)
          sendBtn.addEventListener("click", async () => {
            if (isSending || isResetting) return;

            const text = textarea.value.trim();
            if (!text) return;

            isSending = true;

            const userMsg = document.createElement("div");
            userMsg.className = "msg user";
            userMsg.innerText = text;
            chat.appendChild(userMsg);
            pushHistory("user", text);

            const typing = document.createElement("div");
            typing.className = "msg assistant typing";
            typing.innerText = "";
            chat.appendChild(typing);

            scrollToBottom(wrapper);

            textarea.value = "";
            textarea.disabled = true;
            sendBtn.disabled = true;
            resetChatBtn.disabled = true;

            try {
              const res = await fetch("/llama", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                  prompt: text,
                  system_prompt: appliedSystemPrompt,
                  finetune_id: appliedFinetuneId,
                  ...appliedParams,
                  history: chatHistory
                })
              });

              if (!res.ok) throw new Error("HTTP " + res.status);

              const ct = res.headers.get("content-type") || "";
              if (!ct.includes("application/json")) throw new Error("Invalid response type");

              const data = await res.json();

              typing.remove();

              const answerText = (data && data.answer) ? data.answer : "(Îπà ÏùëÎãµ)";
              const botMsg = document.createElement("div");
              botMsg.className = "msg assistant";
              botMsg.innerText = answerText;
              chat.appendChild(botMsg);

              pushHistory("assistant", answerText);
              scrollToBottom(wrapper);

            } catch (err) {
              typing.remove();
              const errMsg = document.createElement("div");
              errMsg.className = "msg assistant";
              errMsg.innerText = "‚ö†Ô∏è Ïò§Î•ò Î∞úÏÉù\n" + err;
              chat.appendChild(errMsg);
              scrollToBottom(wrapper);
            } finally {
              textarea.disabled = false;
              textarea.focus();
              isSending = false;
              sendBtn.disabled = true;
              resetChatBtn.disabled = false;
            }
          });

          // Reset Chat
          resetChatBtn.addEventListener("click", () => {
            if (isSending || isResetting) return;

            const ok = confirm("ÎåÄÌôî ÎÇ¥Ïó≠ÏùÑ Î™®Îëê Ï¥àÍ∏∞ÌôîÌï†ÍπåÏöî?\n(ÏÉàÎ°úÍ≥†Ïπ®Ìï¥ÎèÑ Î≥µÍµ¨ÎêòÏßÄ ÏïäÏäµÎãàÎã§)");
            if (!ok) return;

            deleteCookie(CHAT_COOKIE_NAME);
            chatHistory = [];

            isResetting = true;

            textarea.disabled = true;
            sendBtn.disabled = true;
            resetChatBtn.disabled = true;

            setOverlay(true, "ÎåÄÌôî Ï¥àÍ∏∞ÌôîÏ§ëÏûÖÎãàÎã§‚Ä¶");
            resetChatForm.submit();
          });

          // Hyper Parameter Sync
          bindRangeNumber(temperature, temperature_num);
          bindRangeNumber(top_p, top_p_num);
          bindRangeNumber(top_k, top_k_num);
          bindRangeNumber(max_tokens, max_tokens_num);
          bindRangeNumber(repetition_penalty, repetition_penalty_num);

          // Reset Params (Ï±ÑÌåÖ ÏÑ§Ï†ïÎßå ÎîîÌè¥Ìä∏Î°ú)
          const resetParamsBtn = document.getElementById("resetParams");
          resetParamsBtn.addEventListener("click", () => {
            setParam("temperature", DEFAULT_PRESET.temperature);
            setParam("top_p", DEFAULT_PRESET.top_p);
            setParam("top_k", DEFAULT_PRESET.top_k);
            setParam("max_tokens", DEFAULT_PRESET.max_tokens);
            setParam("repetition_penalty", DEFAULT_PRESET.repetition_penalty);
            if (systemPromptInput) systemPromptInput.value = DEFAULT_SYSTEM_PROMPT;

            const defFt = DEFAULT_FINETUNE_ID || (FINETUNE_PRESETS[0] ? FINETUNE_PRESETS[0].id : "");
            if(defFt) setSelectedFinetune(defFt);
          });

          // Apply Settings (Ï±ÑÌåÖ Ï†ÅÏö©Îßå)
          const paramForm = document.getElementById("paramForm");
          paramForm.addEventListener("submit", (e) => {
            e.preventDefault();
            setOverlay(true, "ÌîÑÎ°¨ÌîÑÌä∏&ÌïòÏù¥ÌçºÌååÎùºÎØ∏ÌÑ∞ Ï†ÅÏö©Ï§ëÏûÖÎãàÎã§‚Ä¶");

            const cfg = readInputsToChatConfig();
            appliedSystemPrompt = cfg.system_prompt;
            appliedParams = { ...cfg.params };
            appliedFinetuneId = cfg.finetune_id;

            renderAppliedPanel();
            setTimeout(() => setOverlay(false), 250);
          });

          // Fine-tune: Reset Fine-tune Settings
          const ftResetBtn = document.getElementById("ft_reset");
          ftResetBtn.addEventListener("click", () => {
            trainCfg = structuredClone(FALLBACK_TRAIN_CFG);
            // ÏÑúÎ≤Ñ default_train_cfgÍ∞Ä ÏûàÏúºÎ©¥ Îã§Ïãú merge
            trainCfg = deepMerge(trainCfg, SERVER_DEFAULT_TRAIN_CFG || {});
            renderTrainCfgToUI();
            logAppend("[UI] Fine-tune settings reset.");
          });

          // Fine-tune: Export JSON (ÏÇ¨Ïö©Ïûê ÌôïÏù∏Ïö©)
          const ftExportBtn = document.getElementById("ft_export");
          ftExportBtn.addEventListener("click", () => {
            const payload = buildFinetunePayload();
            const out = document.getElementById("ft_payload_preview");
            if (out) out.value = JSON.stringify(payload, null, 2);
            logAppend("[UI] Payload exported (preview updated).");
          });

          // Fine-tune: Start
          const ftStartBtn = document.getElementById("ft_start");
          ftStartBtn.addEventListener("click", async () => {
            if (isFinetuning) return;

            const payload = buildFinetunePayload();

            // ÏµúÏÜå Í≤ÄÏ¶ù
            if (!payload.train_cfg.data.dataset_path) {
              alert("dataset_pathÍ∞Ä ÎπÑÏñ¥ÏûàÏäµÎãàÎã§.");
              return;
            }
            if (payload.train_cfg.prompt.template === "custom" && !(payload.train_cfg.prompt.custom_format || "").trim()) {
              alert("template=customÏù∏Îç∞ custom_formatÏù¥ ÎπÑÏñ¥ÏûàÏäµÎãàÎã§.");
              return;
            }

            isFinetuning = true;
            setOverlay(true, "ÌååÏù∏ÌäúÎãù ÏãúÏûë ÏöîÏ≤≠Ï§ëÏûÖÎãàÎã§‚Ä¶");
            setFtStatus("ÏöîÏ≤≠Ï§ë", "Starting");
            logAppend("[POST] /finetune/start");
            logAppend(JSON.stringify(payload));

            try{
              const res = await fetch("/finetune/start", {
                method: "POST",
                headers: {"Content-Type":"application/json"},
                body: JSON.stringify(payload)
              });

              if (!res.ok) throw new Error("HTTP " + res.status);

              const ct = res.headers.get("content-type") || "";
              const data = ct.includes("application/json") ? await res.json() : { ok: true };

              // Î∞±ÏóîÎìúÍ∞Ä job_idÎ•º ÎÇ¥Î†§Ï£ºÎ©¥ polling Í∞ÄÎä•
              // expected: { job_id: "...", message: "..."}
              const jobId = data && data.job_id ? data.job_id : "";
              logAppend("[OK] finetune started" + (jobId ? (" job_id=" + jobId) : ""));

              setFtStatus(jobId ? ("Ïã§ÌñâÏ§ë ¬∑ " + jobId) : "Ïã§ÌñâÏ§ë", "Running");

              // optional polling (Î∞±ÏóîÎìú Íµ¨ÌòÑ Ïãú)
              // pollFinetune(jobId);

            }catch(err){
              logAppend("[ERR] " + err);
              setFtStatus("Ïã§Ìå®", "Failed");
              alert("ÌååÏù∏ÌäúÎãù ÏãúÏûë Ïã§Ìå®: " + err);
            }finally{
              setOverlay(false);
              isFinetuning = false;
            }
          });

          // overlay Ïù¥Î≤§Ìä∏ Î®πÍ∏∞
          const overlay = document.getElementById("overlay");
          overlay.addEventListener("click", (e) => e.preventDefault());
          overlay.addEventListener("wheel", (e) => e.preventDefault(), { passive: false });
          document.addEventListener("keydown", (e) => {
            if (overlay.style.display === "flex") e.preventDefault();
          }, { capture: true });
        });

        // (ÏÑ†ÌÉù) Ìè¥ÎßÅ ÏÉòÌîå: Î∞±ÏóîÎìú Íµ¨ÌòÑÌïòÎ©¥ ÏÇ¨Ïö©
        async function pollFinetune(jobId){
          if (!jobId) return;
          try{
            const res = await fetch(`/finetune/status?job_id=${encodeURIComponent(jobId)}`);
            if (!res.ok) return;
            const data = await res.json();
            // expected: { status:"running|done|failed", logs:["..."], progress:{...} }
            if (Array.isArray(data.logs)) data.logs.forEach(line => logAppend(line));
            if (data.status === "done") setFtStatus("ÏôÑÎ£å", "Done");
            else if (data.status === "failed") setFtStatus("Ïã§Ìå®", "Failed");
            else setFtStatus("Ïã§ÌñâÏ§ë ¬∑ " + jobId, "Running");

            if (data.status === "running") setTimeout(() => pollFinetune(jobId), 1500);
          }catch(e){
            // ignore
          }
        }
    </script>
</head>

<body>
<div class="overlay" id="overlay">
    <div class="overlay-box" id="overlayText">Ï≤òÎ¶¨Ï§ë‚Ä¶</div>
</div>

<div class="page-wrapper">

    <!-- NAVIGATION BAR (Í≥µÏö©) - ÏàòÏ†ï Í∏àÏßÄ -->
    <nav class="navbar navbar-expand-lg predict-navbar">
        <div class="container-fluid px-4">
            <a class="navbar-brand" href="{{ url_for('index.index') }}">
                <img src="{{ url_for('static', filename='image/logo2.png') }}"
                     alt="Ï≤≠ÎÖÑ Ï£ºÍ±∞ ÏÜîÎ£®ÏÖò Î°úÍ≥†"
                     style="height:40px; width:auto;">
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#topNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="topNav">
                <ul class="navbar-nav ms-auto align-items-center">
                    <li class="nav-item ms-3">
                        <a class="nav-link" href="{{ url_for('predict.predict_search') }}">Ï†ÑÏõîÏÑ∏ ÏòàÏ∏°</a>
                    </li>
                    <li class="nav-item ms-3">
                        <a class="nav-link" href="{{ url_for('support.support_search') }}">Ï†ïÎ∂ÄÏßÄÏõê</a>
                    </li>
                    <li class="nav-item ms-3">
                        <a class="nav-link" href="{{ url_for('login.login') }}">Î°úÍ∑∏Ïù∏</a>
                    </li>
                    <li class="nav-item ms-3">
                        <a class="nav-link" href="{{ url_for('login.signup') }}">ÌöåÏõêÍ∞ÄÏûÖ</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="app">
        <!-- LEFT -->
        <div class="main">
            <header>
                <div class="header-title">LLaMA3 8B Chat</div>

                <button id="resetChat" type="button" class="reset-chat-btn">Reset Chat</button>

                <form id="resetChatForm" method="post" style="display:none;">
                    <input type="hidden" name="action" value="reset_chat">
                </form>
            </header>

            <div class="chat-wrapper">
                <div class="chat">
                    {% for msg in chat_history %}
                    <div class="msg {{ msg.role }}">{{ msg.content }}</div>
                    {% endfor %}
                </div>
            </div>

            <div class="input-bar">
                <div class="input-inner">
                    <textarea id="prompt" rows="2" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."></textarea>
                    <button id="send" type="button">Send</button>
                </div>
            </div>
        </div>

        <!-- RIGHT -->
        <form id="paramForm" method="post" class="settings">

            <!-- (A) ÌòÑÌô©Ìåê: Ï±ÑÌåÖ Ï†ÅÏö©Ï§ë -->
            <div class="card-block">
                <div class="status-top">
                    <div class="status-title">ÌòÑÏû¨ Ï†ÅÏö©Ï§ë (Chat)</div>
                    <div id="appliedBadge" class="status-badge">ÎîîÌè¥Ìä∏</div>
                </div>

                <div class="status-row">
                    <div class="status-label">Checkpoint</div>
                    <div class="status-value">
                        <span id="appliedFinetune" class="status-ellipsis"></span>
                    </div>
                </div>

                <div class="status-row">
                    <div class="status-label">System Prompt</div>
                    <div class="status-value">
                        <span id="appliedPrompt" class="status-ellipsis"></span>
                    </div>
                </div>

                <div class="status-grid">
                    <div class="kv">
                        <div class="k">temperature</div>
                        <div class="v" id="applied_temperature">-</div>
                    </div>
                    <div class="kv">
                        <div class="k">top_p</div>
                        <div class="v" id="applied_top_p">-</div>
                    </div>
                    <div class="kv">
                        <div class="k">top_k</div>
                        <div class="v" id="applied_top_k">-</div>
                    </div>
                    <div class="kv">
                        <div class="k">max_tokens</div>
                        <div class="v" id="applied_max_tokens">-</div>
                    </div>
                    <div class="kv">
                        <div class="k">repetition_penalty</div>
                        <div class="v" id="applied_repetition_penalty">-</div>
                    </div>
                </div>
            </div>

            <!-- (B) Ï≤¥ÌÅ¨Ìè¨Ïù∏Ìä∏ ÌîÑÎ¶¨ÏÖã: Ïú†ÏßÄ -->
            <div class="finetune-wrap">
                <div class="finetune-head">
                    <div class="finetune-head-left">
                        <div class="finetune-head-title">Checkpoint Preset</div>
                        <div class="finetune-head-desc">Ï≤¥ÌÅ¨Ìè¨Ïù∏Ìä∏(Í∞ÄÏ§ëÏπò/ÌîÑÎ¶¨ÏÖã)Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî. (Chat/Finetune Î™®Îëê ÎèôÏùº ÏÑ†ÌÉùÍ∞íÏùÑ Í∏∞Ï§ÄÏúºÎ°ú ÎèôÏûë)</div>
                    </div>
                </div>
                <div id="finetuneGrid" class="finetune-grid"></div>
                <input type="hidden" id="finetuneInput" name="finetune_id" value="">
            </div>

            <!-- (C) Ï±ÑÌåÖ ÏÑ§Ï†ï -->
            <div class="card-block">
                <div class="section-title">
                    <div class="t">Chat Settings</div>
                    <div class="pill-mini">Inference</div>
                </div>

                <div class="field">
                    <label>System Prompt</label>
                    <textarea id="systemPromptInput" name="system_prompt" rows="4">{{ default_system_prompt if default_system_prompt is defined else system_prompt }}</textarea>
                </div>

                <div class="divider"></div>

                <div class="field">
                    <label>Temperature (Ï∞ΩÏùòÏÑ±/Î¨¥ÏûëÏúÑÏÑ±)</label>
                    <div class="grid-2">
                        <input id="temperature" type="range" min="0.1" max="1.5" step="0.1"
                               value="{{ default_params.temperature }}">
                        <input id="temperature_num" type="number" min="0.1" max="1.5" step="0.1"
                               value="{{ default_params.temperature }}">
                    </div>
                </div>

                <div class="field">
                    <label>Top-p (ÎàÑÏ†ÅÌôïÎ•† Í∏∞Ï§Ä)</label>
                    <div class="grid-2">
                        <input id="top_p" type="range" min="0.1" max="1" step="0.05" value="{{ default_params.top_p }}">
                        <input id="top_p_num" type="number" min="0.1" max="1" step="0.05"
                               value="{{ default_params.top_p }}">
                    </div>
                </div>

                <div class="field">
                    <label>Top-k (ÌõÑÎ≥¥ ÌÜ†ÌÅ∞ Í∞úÏàò)</label>
                    <div class="grid-2">
                        <input id="top_k" type="range" min="0" max="100" step="1" value="{{ default_params.top_k }}">
                        <input id="top_k_num" type="number" min="0" max="100" step="1"
                               value="{{ default_params.top_k }}">
                    </div>
                </div>

                <div class="field">
                    <label>Max Tokens (ÏµúÎåÄ ÏÉùÏÑ± Í∏∏Ïù¥)</label>
                    <div class="grid-2">
                        <input id="max_tokens" type="range" min="32" max="2048" step="32"
                               value="{{ default_params.max_tokens }}">
                        <input id="max_tokens_num" type="number" min="32" max="2048" step="32"
                               value="{{ default_params.max_tokens }}">
                    </div>
                </div>

                <div class="field">
                    <label>Repetition Penalty (Î∞òÎ≥µ ÏñµÏ†ú Í∞ïÎèÑ)</label>
                    <div class="grid-2">
                        <input id="repetition_penalty" type="range" min="1" max="1.5" step="0.05"
                               value="{{ default_params.repetition_penalty }}">
                        <input id="repetition_penalty_num" type="number" min="1" max="1.5" step="0.05"
                               value="{{ default_params.repetition_penalty }}">
                    </div>
                </div>

                <button type="button" id="resetParams" class="btn-ghost">Reset Chat Settings</button>
                <button class="btn-brand" type="submit">Apply Chat Settings</button>
            </div>

            <!-- (D) ÌååÏù∏ÌäúÎãù ÏÑ§Ï†ï(ÏÇ¨Ïö©ÏûêÍ∞Ä ÏßÅÏ†ë Ï°∞Ï†à) -->
            <div class="card-block">
                <div class="section-title">
                    <div class="t">Fine-tune Settings</div>
                    <div class="pill-mini">Training</div>
                </div>

                <div class="hint">
                    Ï≤¥ÌÅ¨Ìè¨Ïù∏Ìä∏ ÏÑ†ÌÉù(ÏúÑ ÌîÑÎ¶¨ÏÖã) + ÏïÑÎûò ÏÑ§Ï†ïÍ∞íÏúºÎ°ú <span class="mono">POST /finetune/start</span> Î•º Ìò∏Ï∂úÌï©ÎãàÎã§.
                </div>

                <!-- Data -->
                <div class="divider"></div>
                <div class="section-title">
                    <div class="t">Data</div>
                    <div class="pill-mini">Dataset</div>
                </div>

                <div class="field">
                    <label>dataset_path (ÌïôÏäµ Îç∞Ïù¥ÌÑ∞ Í≤ΩÎ°ú: jsonl Í∂åÏû•)</label>
                    <input id="ft_dataset_path" type="text" placeholder="/workspace/data/train.jsonl">
                </div>

                <div class="field">
                    <label>eval_path (ÏÑ†ÌÉù: Í≤ÄÏ¶ù Îç∞Ïù¥ÌÑ∞ Í≤ΩÎ°ú)</label>
                    <input id="ft_eval_path" type="text" placeholder="">
                </div>

                <div class="grid-2">
                    <div class="field">
                        <label>text_field (jsonlÏóêÏÑú ÏÇ¨Ïö©Ìï† ÌÖçÏä§Ìä∏ ÌÇ§)</label>
                        <input id="ft_text_field" type="text" placeholder="text">
                    </div>
                    <div class="field">
                        <label>split_ratio (0Ïù¥Î©¥ eval ÎØ∏ÏÇ¨Ïö©)</label>
                        <input id="ft_split_ratio" type="number" step="0.01" min="0" max="0.5" placeholder="0">
                    </div>
                </div>

                <div class="grid-2">
                    <div class="field">
                        <label>max_seq_length</label>
                        <input id="ft_max_seq_length" type="number" step="1" min="256" max="8192" placeholder="2048">
                    </div>
                    <div class="field">
                        <label>packing (ÏßßÏùÄ ÏÉòÌîå Ìå®ÌÇπ)</label>
                        <select id="ft_packing">
                            <option value="false">false</option>
                            <option value="true">true</option>
                        </select>
                    </div>
                </div>

                <div class="hint" id="ft_eval_hint">-</div>

                <!-- Prompt -->
                <div class="divider"></div>
                <div class="section-title">
                    <div class="t">Prompt Format</div>
                    <div class="pill-mini">Template</div>
                </div>

                <div class="grid-2">
                    <div class="field">
                        <label>template</label>
                        <select id="ft_template">
                            <option value="alpaca">alpaca</option>
                            <option value="chatml">chatml</option>
                            <option value="custom">custom</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>instruction_key / response_key</label>
                        <div class="grid-2">
                            <input id="ft_instruction_key" type="text" placeholder="instruction">
                            <input id="ft_response_key" type="text" placeholder="response">
                        </div>
                    </div>
                </div>

                <div class="field" id="ft_custom_wrap" style="display:none;">
                    <label>custom_format (template=customÏùº Îïå ÏÇ¨Ïö©)</label>
                    <textarea id="ft_custom_format" rows="4"
                              placeholder="Ïòà: Below is ... ### Instruction: {instruction} ### Response: {response}"></textarea>
                </div>

                <!-- LoRA -->
                <div class="divider"></div>
                <div class="section-title">
                    <div class="t">LoRA</div>
                    <div class="pill-mini">PEFT</div>
                </div>

                <div class="grid-3">
                    <div class="field">
                        <label>r</label>
                        <input id="ft_lora_r" type="number" step="1" min="1" max="256">
                    </div>
                    <div class="field">
                        <label>alpha</label>
                        <input id="ft_lora_alpha" type="number" step="1" min="1" max="512">
                    </div>
                    <div class="field">
                        <label>dropout</label>
                        <input id="ft_lora_dropout" type="number" step="0.01" min="0" max="0.5">
                    </div>
                </div>

                <div class="field">
                    <label>target_modules (CSV)</label>
                    <input id="ft_lora_targets" type="text" placeholder="q_proj,k_proj,v_proj,o_proj">
                </div>

                <div class="field">
                    <label>bias</label>
                    <select id="ft_lora_bias">
                        <option value="none">none</option>
                        <option value="all">all</option>
                        <option value="lora_only">lora_only</option>
                    </select>
                </div>

                <!-- Quant -->
                <div class="divider"></div>
                <div class="section-title">
                    <div class="t">Quantization</div>
                    <div class="pill-mini">bitsandbytes</div>
                </div>

                <div class="grid-2">
                    <div class="field">
                        <label>load_in_4bit</label>
                        <select id="ft_4bit">
                            <option value="true">true</option>
                            <option value="false">false</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>bnb_4bit_use_double_quant</label>
                        <select id="ft_double_quant">
                            <option value="true">true</option>
                            <option value="false">false</option>
                        </select>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="field">
                        <label>bnb_4bit_quant_type</label>
                        <select id="ft_quant_type">
                            <option value="nf4">nf4</option>
                            <option value="fp4">fp4</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>bnb_4bit_compute_dtype</label>
                        <select id="ft_compute_dtype">
                            <option value="bfloat16">bfloat16</option>
                            <option value="float16">float16</option>
                            <option value="float32">float32</option>
                        </select>
                    </div>
                </div>

                <!-- Train -->
                <div class="divider"></div>
                <div class="section-title">
                    <div class="t">Training</div>
                    <div class="pill-mini">Args</div>
                </div>

                <div class="field">
                    <label>base_model</label>
                    <input id="ft_base_model" type="text" placeholder="meta-llama/Meta-Llama-3-8B">
                </div>

                <div class="grid-2">
                    <div class="field">
                        <label>learning_rate</label>
                        <input id="ft_lr" type="number" step="0.000001" min="0.000001" max="0.005">
                    </div>
                    <div class="field">
                        <label>per_device_train_batch_size</label>
                        <input id="ft_bsz" type="number" step="1" min="1" max="64">
                    </div>
                </div>

                <div class="grid-2">
                    <div class="field">
                        <label>gradient_accumulation_steps</label>
                        <input id="ft_gas" type="number" step="1" min="1" max="256">
                    </div>
                    <div class="field">
                        <label>max_steps</label>
                        <input id="ft_max_steps" type="number" step="1" min="1" max="100000">
                    </div>
                </div>

                <div class="grid-2">
                    <div class="field">
                        <label>warmup_ratio</label>
                        <input id="ft_warmup_ratio" type="number" step="0.01" min="0" max="0.3">
                    </div>
                    <div class="field">
                        <label>weight_decay</label>
                        <input id="ft_weight_decay" type="number" step="0.01" min="0" max="1">
                    </div>
                </div>

                <div class="grid-2">
                    <div class="field">
                        <label>lr_scheduler_type</label>
                        <select id="ft_sched">
                            <option value="cosine">cosine</option>
                            <option value="linear">linear</option>
                            <option value="constant">constant</option>
                            <option value="constant_with_warmup">constant_with_warmup</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>optim</label>
                        <select id="ft_optim">
                            <option value="paged_adamw_8bit">paged_adamw_8bit</option>
                            <option value="paged_adamw_32bit">paged_adamw_32bit</option>
                            <option value="adamw_torch">adamw_torch</option>
                        </select>
                    </div>
                </div>

                <div class="grid-3">
                    <div class="field">
                        <label>bf16</label>
                        <select id="ft_bf16">
                            <option value="true">true</option>
                            <option value="false">false</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>fp16</label>
                        <select id="ft_fp16">
                            <option value="false">false</option>
                            <option value="true">true</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>seed</label>
                        <input id="ft_seed" type="number" step="1" min="0" max="2147483647">
                    </div>
                </div>

                <div class="grid-3">
                    <div class="field">
                        <label>logging_steps</label>
                        <input id="ft_logging_steps" type="number" step="1" min="1" max="100000">
                    </div>
                    <div class="field">
                        <label>save_steps</label>
                        <input id="ft_save_steps" type="number" step="1" min="1" max="100000">
                    </div>
                    <div class="field">
                        <label>eval_steps (eval ÌôúÏÑ± Ïãú)</label>
                        <input id="ft_eval_steps" type="number" step="1" min="0" max="100000">
                    </div>
                </div>

                <!-- Output -->
                <div class="divider"></div>
                <div class="section-title">
                    <div class="t">Output</div>
                    <div class="pill-mini">Artifacts</div>
                </div>

                <div class="field">
                    <label>output_dir</label>
                    <input id="ft_output_dir" type="text" placeholder="/workspace/fine_tune_output">
                </div>

                <div class="grid-2">
                    <div class="field">
                        <label>run_name</label>
                        <input id="ft_run_name" type="text" placeholder="llama3_lora_sft">
                    </div>
                    <div class="field">
                        <label>save_total_limit</label>
                        <input id="ft_save_total_limit" type="number" step="1" min="1" max="50">
                    </div>
                </div>

                <div class="grid-2">
                    <div class="field">
                        <label>push_to_hub</label>
                        <select id="ft_push_to_hub">
                            <option value="false">false</option>
                            <option value="true">true</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>hub_repo_id (push_to_hub=trueÏùº Îïå)</label>
                        <input id="ft_hub_repo_id" type="text" placeholder="">
                    </div>
                </div>

                <!-- Controls -->
                <div class="divider"></div>
                <div class="section-title">
                    <div class="t">Run</div>
                    <div class="pill-mini" id="ft_status_pill">Ready</div>
                </div>

                <div class="field">
                    <label>Status</label>
                    <input id="ft_status" type="text" value="-" disabled>
                </div>

                <div class="inline-row">
                    <button type="button" id="ft_reset" class="btn-ghost" style="margin-top:0;">Reset Fine-tune
                        Settings
                    </button>
                </div>

                <div class="inline-row">
                    <button type="button" id="ft_export" class="btn-ghost" style="margin-top:0;">Export Payload JSON
                    </button>
                </div>

                <div class="field">
                    <label>Payload Preview (JSON)</label>
                    <textarea id="ft_payload_preview" rows="7" class="mono"
                              placeholder="ExportÎ•º ÎàÑÎ•¥Î©¥ Ïó¨Í∏∞Ïóê payloadÍ∞Ä ÌëúÏãúÎê©ÎãàÎã§."></textarea>
                </div>

                <button type="button" id="ft_start" class="btn-brand">Start Fine-tune</button>

                <div class="divider"></div>
                <div class="field">
                    <label>Logs</label>
                    <div id="ft_logs" class="logbox mono"></div>
                </div>
            </div>

        </form>
    </div>
</div>
</body>
</html>
